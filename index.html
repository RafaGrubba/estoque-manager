<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#1a1a2e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Despensa">
<link rel="manifest" href="manifest.json">
<title>Despensa</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f1a;
    --bg2: #16162a;
    --bg3: #1e1e35;
    --card: #1a1a30;
    --card2: #22223a;
    --accent: #7c6af7;
    --accent2: #a78bfa;
    --accent3: #c4b5fd;
    --green: #34d399;
    --yellow: #fbbf24;
    --red: #f87171;
    --text: #f0eeff;
    --text2: #a0a0c0;
    --text3: #6060a0;
    --border: rgba(124,106,247,0.18);
    --glow: 0 0 30px rgba(124,106,247,0.15);
    --r: 16px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  html, body {
    height: 100%;
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    overflow: hidden;
  }

  /* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
  #app {
    height: 100dvh;
    display: flex;
    flex-direction: column;
    max-width: 480px;
    margin: 0 auto;
    position: relative;
    overflow: hidden;
  }

  /* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
  .screen {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    opacity: 0;
    pointer-events: none;
    transition: opacity .25s ease, transform .25s ease;
    transform: translateY(8px);
    overflow: hidden;
  }
  .screen.active {
    opacity: 1;
    pointer-events: all;
    transform: translateY(0);
  }

  /* ‚îÄ‚îÄ SCROLLABLE CONTENT ‚îÄ‚îÄ */
  .scroll-content {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 90px;
  }
  .scroll-content::-webkit-scrollbar { display: none; }

  /* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
  #bottom-nav {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 480px;
    background: rgba(15,15,26,0.95);
    backdrop-filter: blur(20px);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 8px 0;
    height: 72px;
    z-index: 100;
  }
  .nav-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    height: 60px;
    border-radius: 12px;
    border: none;
    background: transparent;
    color: var(--text3);
    font-family: 'DM Sans', sans-serif;
    font-size: 10px;
    font-weight: 500;
    letter-spacing: .04em;
    cursor: pointer;
    transition: all .2s;
    position: relative;
  }
  .nav-btn svg { transition: all .2s; }
  .nav-btn.active { color: var(--accent2); }
  .nav-btn.active svg { filter: drop-shadow(0 0 6px var(--accent)); }
  .nav-btn.scan-btn {
    background: linear-gradient(135deg, var(--accent) 0%, #a78bfa 100%);
    color: white;
    box-shadow: 0 4px 20px rgba(124,106,247,0.45);
    flex: none;
    width: 56px;
    height: 56px;
    border-radius: 18px;
    margin: 0 8px;
    margin-bottom: 8px;
  }
  .nav-btn.scan-btn svg { width: 26px; height: 26px; }
  .nav-btn span { font-size: 10px; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .header {
    padding: 52px 20px 16px;
    background: linear-gradient(180deg, var(--bg) 0%, transparent 100%);
    position: relative;
    z-index: 10;
  }
  .header h1 {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 28px;
    color: var(--text);
    letter-spacing: -.02em;
  }
  .header h1 span { color: var(--accent2); }
  .header p { color: var(--text2); font-size: 13px; margin-top: 2px; }

  /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 16px;
  }
  .card-lg {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 20px;
  }

  /* ‚îÄ‚îÄ HOME SCREEN ‚îÄ‚îÄ */
  .home-stats {
    padding: 4px 20px 0;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 16px;
    position: relative;
    overflow: hidden;
  }
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    border-radius: 2px 2px 0 0;
  }
  .stat-card.purple::before { background: linear-gradient(90deg, var(--accent), var(--accent2)); }
  .stat-card.green::before { background: linear-gradient(90deg, var(--green), #6ee7b7); }
  .stat-card.yellow::before { background: linear-gradient(90deg, var(--yellow), #fde68a); }
  .stat-card.red::before { background: linear-gradient(90deg, var(--red), #fca5a5); }
  .stat-num {
    font-family: 'Syne', sans-serif;
    font-size: 32px;
    font-weight: 800;
    line-height: 1;
  }
  .stat-label { color: var(--text2); font-size: 11px; margin-top: 4px; text-transform: uppercase; letter-spacing: .06em; }

  .section-title {
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .1em;
    color: var(--text3);
    padding: 20px 20px 10px;
  }

  /* ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ */
  .alert-list { padding: 0 20px; display: flex; flex-direction: column; gap: 8px; }
  .alert-item {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--card);
    border: 1px solid rgba(248,113,113,0.2);
    border-radius: 12px;
    padding: 12px 14px;
  }
  .alert-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--red); flex-shrink: 0; box-shadow: 0 0 8px var(--red); }
  .alert-name { font-size: 13px; font-weight: 500; flex: 1; }
  .alert-qty { font-size: 12px; color: var(--red); font-weight: 600; }

  /* ‚îÄ‚îÄ ESTOQUE SCREEN ‚îÄ‚îÄ */
  .search-wrap { padding: 0 20px 12px; }
  .search-input {
    width: 100%;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px 16px 12px 44px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    outline: none;
    transition: border-color .2s;
    position: relative;
  }
  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--text3); }
  .search-wrap { position: relative; }
  .search-icon {
    position: absolute;
    left: 32px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text3);
  }

  /* category tabs */
  .cat-tabs {
    display: flex;
    gap: 8px;
    padding: 0 20px 14px;
    overflow-x: auto;
    scrollbar-width: none;
  }
  .cat-tabs::-webkit-scrollbar { display: none; }
  .cat-tab {
    flex-shrink: 0;
    padding: 7px 16px;
    border-radius: 100px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text2);
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all .2s;
    white-space: nowrap;
  }
  .cat-tab.active {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
    box-shadow: 0 2px 12px rgba(124,106,247,0.4);
  }

  .product-list { padding: 0 20px; display: flex; flex-direction: column; gap: 8px; }
  .product-item {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px;
    transition: all .2s;
    cursor: pointer;
    animation: slideIn .25s ease forwards;
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .product-item:active { transform: scale(.98); }
  .product-emoji {
    width: 42px; height: 42px;
    border-radius: 12px;
    background: var(--card2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    flex-shrink: 0;
  }
  .product-info { flex: 1; min-width: 0; }
  .product-name { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .product-cat { font-size: 11px; color: var(--text2); margin-top: 2px; }
  .product-qty {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
  }
  .qty-num {
    font-family: 'Syne', sans-serif;
    font-size: 20px;
    font-weight: 700;
    line-height: 1;
  }
  .qty-num.zero { color: var(--red); }
  .qty-num.low { color: var(--yellow); }
  .qty-num.ok { color: var(--green); }
  .qty-label { font-size: 10px; color: var(--text3); text-transform: uppercase; letter-spacing: .04em; }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(10,10,20,0.85);
    backdrop-filter: blur(8px);
    z-index: 200;
    display: flex;
    align-items: flex-end;
    opacity: 0;
    pointer-events: none;
    transition: opacity .25s;
  }
  .modal-overlay.open {
    opacity: 1;
    pointer-events: all;
  }
  .modal {
    width: 100%;
    max-width: 480px;
    margin: 0 auto;
    background: var(--bg2);
    border-radius: 24px 24px 0 0;
    border: 1px solid var(--border);
    border-bottom: none;
    padding: 0 0 32px;
    transform: translateY(100%);
    transition: transform .3s cubic-bezier(0.34,1.56,0.64,1);
    max-height: 90dvh;
    overflow-y: auto;
  }
  .modal-overlay.open .modal {
    transform: translateY(0);
  }
  .modal-handle {
    width: 40px; height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin: 12px auto 0;
  }
  .modal-header {
    padding: 20px 20px 0;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 12px;
  }
  .modal-title {
    font-family: 'Syne', sans-serif;
    font-size: 20px;
    font-weight: 800;
  }
  .modal-sub { color: var(--text2); font-size: 13px; margin-top: 3px; }
  .modal-close {
    width: 32px; height: 32px;
    border-radius: 50%;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text2);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
    font-size: 18px;
  }

  /* quick actions in modal */
  .quick-btns {
    display: flex;
    gap: 8px;
    padding: 20px 20px 0;
  }
  .quick-btn {
    flex: 1;
    padding: 14px 0;
    border-radius: 14px;
    border: none;
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all .15s;
  }
  .quick-btn:active { transform: scale(.95); }
  .quick-btn.add { background: linear-gradient(135deg, var(--accent), var(--accent2)); color: white; box-shadow: 0 4px 16px rgba(124,106,247,0.35); }
  .quick-btn.remove { background: var(--card2); color: var(--text); border: 1px solid var(--border); }
  .quick-btn.add-custom { background: var(--card2); color: var(--accent2); border: 1px solid var(--border); font-size: 13px; }

  /* big qty display */
  .modal-qty-display {
    text-align: center;
    padding: 24px 0 8px;
  }
  .modal-qty-num {
    font-family: 'Syne', sans-serif;
    font-size: 64px;
    font-weight: 800;
    line-height: 1;
  }
  .modal-qty-label { color: var(--text2); font-size: 13px; margin-top: 4px; }

  .divider {
    height: 1px;
    background: var(--border);
    margin: 20px 20px 0;
  }

  /* input */
  .input-row { padding: 16px 20px 0; display: flex; flex-direction: column; gap: 8px; }
  .input-label { font-size: 12px; color: var(--text2); text-transform: uppercase; letter-spacing: .06em; }
  .text-input {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 16px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    outline: none;
    transition: border-color .2s;
    width: 100%;
  }
  .text-input:focus { border-color: var(--accent); }
  .text-input::placeholder { color: var(--text3); }
  select.text-input { cursor: pointer; }
  select.text-input option { background: var(--bg2); }

  .action-btn {
    width: calc(100% - 40px);
    margin: 16px 20px 0;
    padding: 16px;
    border-radius: 14px;
    border: none;
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all .15s;
  }
  .action-btn.primary {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: white;
    box-shadow: 0 4px 20px rgba(124,106,247,0.35);
  }
  .action-btn.danger { background: rgba(248,113,113,0.15); color: var(--red); border: 1px solid rgba(248,113,113,0.3); }
  .action-btn:active { transform: scale(.98); }

  /* ‚îÄ‚îÄ SCANNER SCREEN ‚îÄ‚îÄ */
  #scanner-screen {
    background: #000;
    z-index: 150;
  }
  #scanner-screen .header {
    background: transparent;
    position: absolute;
    top: 0; left: 0; right: 0;
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 52px 20px 16px;
  }
  .back-btn {
    width: 38px; height: 38px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.15);
    color: white;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
    backdrop-filter: blur(10px);
  }
  #scanner-screen .header h2 {
    font-family: 'Syne', sans-serif;
    font-size: 18px;
    font-weight: 700;
    color: white;
  }
  #scanner-video-wrap {
    position: absolute;
    inset: 0;
    overflow: hidden;
  }
  #scanner-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .scanner-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }
  .scanner-frame {
    width: 240px; height: 240px;
    position: relative;
  }
  .scanner-frame::before, .scanner-frame::after,
  .scanner-corner1, .scanner-corner2 {
    content: '';
    position: absolute;
    width: 32px; height: 32px;
  }
  .scanner-frame::before { top: 0; left: 0; border-top: 3px solid var(--accent2); border-left: 3px solid var(--accent2); border-radius: 4px 0 0 0; }
  .scanner-frame::after { top: 0; right: 0; border-top: 3px solid var(--accent2); border-right: 3px solid var(--accent2); border-radius: 0 4px 0 0; }
  .scanner-corner1 { bottom: 0; left: 0; border-bottom: 3px solid var(--accent2); border-left: 3px solid var(--accent2); border-radius: 0 0 0 4px; }
  .scanner-corner2 { bottom: 0; right: 0; border-bottom: 3px solid var(--accent2); border-right: 3px solid var(--accent2); border-radius: 0 0 4px 0; }
  .scan-line {
    position: absolute;
    left: 4px; right: 4px;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent2), transparent);
    top: 0;
    animation: scanMove 2s ease-in-out infinite;
    box-shadow: 0 0 8px var(--accent);
  }
  @keyframes scanMove {
    0%, 100% { top: 4px; }
    50% { top: calc(100% - 6px); }
  }
  .scanner-hint {
    margin-top: 28px;
    color: rgba(255,255,255,0.7);
    font-size: 13px;
    text-align: center;
    padding: 0 40px;
  }
  .scanner-manual {
    position: absolute;
    bottom: 100px;
    left: 20px; right: 20px;
  }
  .scanner-manual-btn {
    width: 100%;
    padding: 14px;
    border-radius: 14px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: white;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    cursor: pointer;
    backdrop-filter: blur(10px);
    pointer-events: all;
  }

  /* ‚îÄ‚îÄ HISTORICO ‚îÄ‚îÄ */
  .hist-list { padding: 0 20px; display: flex; flex-direction: column; gap: 8px; }
  .hist-item {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px 14px;
  }
  .hist-icon {
    width: 36px; height: 36px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }
  .hist-icon.entry { background: rgba(52,211,153,0.15); }
  .hist-icon.exit { background: rgba(248,113,113,0.1); }
  .hist-info { flex: 1; min-width: 0; }
  .hist-name { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .hist-date { font-size: 11px; color: var(--text2); margin-top: 2px; }
  .hist-qty { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; }
  .hist-qty.entry { color: var(--green); }
  .hist-qty.exit { color: var(--red); }

  /* ‚îÄ‚îÄ LISTA DE COMPRAS ‚îÄ‚îÄ */
  .shopping-item {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px;
    cursor: pointer;
    transition: all .2s;
  }
  .shopping-item.checked {
    opacity: .5;
  }
  .check-circle {
    width: 22px; height: 22px;
    border-radius: 50%;
    border: 2px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    transition: all .2s;
  }
  .shopping-item.checked .check-circle {
    background: var(--accent);
    border-color: var(--accent);
  }

  /* toast */
  .toast {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--card2);
    border: 1px solid var(--border);
    border-radius: 100px;
    padding: 10px 20px;
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
    z-index: 500;
    opacity: 0;
    pointer-events: none;
    transition: all .3s;
    white-space: nowrap;
    max-width: calc(100% - 40px);
  }
  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* empty state */
  .empty {
    text-align: center;
    padding: 60px 40px;
    color: var(--text3);
  }
  .empty-icon { font-size: 48px; margin-bottom: 12px; }
  .empty h3 { font-family: 'Syne', sans-serif; font-size: 18px; color: var(--text2); margin-bottom: 6px; }
  .empty p { font-size: 13px; line-height: 1.6; }

  /* FAB */
  .fab {
    position: absolute;
    bottom: 84px;
    right: 20px;
    width: 48px; height: 48px;
    border-radius: 16px;
    background: var(--card2);
    border: 1px solid var(--border);
    color: var(--accent2);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    transition: all .2s;
    z-index: 50;
  }
  .fab:active { transform: scale(.92); }

  /* badge */
  .badge {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 100px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .05em;
  }
  .badge.cat {
    background: rgba(124,106,247,0.15);
    color: var(--accent2);
  }

  /* expiry */
  .expiry-badge {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 100px;
    font-weight: 600;
  }
  .expiry-ok { background: rgba(52,211,153,0.15); color: var(--green); }
  .expiry-soon { background: rgba(251,191,36,0.15); color: var(--yellow); }
  .expiry-expired { background: rgba(248,113,113,0.15); color: var(--red); }

  /* whatsapp share */
  .wa-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    width: calc(100% - 40px);
    margin: 12px 20px 0;
    padding: 14px 20px;
    border-radius: 14px;
    border: none;
    background: rgba(37,211,102,0.12);
    border: 1px solid rgba(37,211,102,0.25);
    color: #25d366;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all .15s;
  }
  .wa-btn:active { transform: scale(.98); }

  /* number stepper */
  .stepper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    padding: 16px 20px 0;
  }
  .stepper-btn {
    width: 44px; height: 44px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    font-size: 22px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: all .15s;
    user-select: none;
  }
  .stepper-btn:active { transform: scale(.92); background: var(--card2); }
  .stepper-val {
    font-family: 'Syne', sans-serif;
    font-size: 32px;
    font-weight: 800;
    width: 60px;
    text-align: center;
  }

  /* progress bar */
  .progress-bar {
    height: 3px;
    background: var(--bg3);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 6px;
  }
  .progress-fill {
    height: 100%;
    border-radius: 2px;
    transition: width .4s ease;
  }

  @media (prefers-color-scheme: light) { /* still dark */ }
</style>
</head>
<body>
<div id="app">

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="screen active" id="home-screen">
    <div class="header">
      <h1>Minha <span>Despensa</span></h1>
      <p id="home-date"></p>
    </div>
    <div class="scroll-content">
      <div class="home-stats">
        <div class="stat-card purple">
          <div class="stat-num" id="stat-total">0</div>
          <div class="stat-label">Produtos</div>
        </div>
        <div class="stat-card green">
          <div class="stat-num" id="stat-ok">0</div>
          <div class="stat-label">Em estoque</div>
        </div>
        <div class="stat-card yellow">
          <div class="stat-num" id="stat-low">0</div>
          <div class="stat-label">Acabando</div>
        </div>
        <div class="stat-card red">
          <div class="stat-num" id="stat-empty">0</div>
          <div class="stat-label">Zerados</div>
        </div>
      </div>

      <div class="section-title" id="alerts-title" style="display:none">‚ö† Aten√ß√£o</div>
      <div class="alert-list" id="alerts-list"></div>

      <div class="section-title">üì¶ Recentes</div>
      <div class="product-list" id="recent-list">
        <div class="empty"><div class="empty-icon">üõí</div><h3>Estoque vazio</h3><p>Escaneie um produto para come√ßar</p></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ESTOQUE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="screen" id="stock-screen">
    <div class="header">
      <h1>Estoque</h1>
    </div>
    <div class="search-wrap" style="padding:0 20px 12px;position:relative;">
      <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input class="search-input" id="search-input" type="search" placeholder="Buscar produto‚Ä¶" oninput="filterProducts()">
    </div>
    <div class="cat-tabs" id="cat-tabs">
      <button class="cat-tab active" onclick="filterCat('Todos',this)">Todos</button>
    </div>
    <div class="scroll-content" style="padding-bottom:90px">
      <div class="product-list" id="stock-list"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCANNER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="screen" id="scanner-screen">
    <div id="scanner-video-wrap">
      <video id="scanner-video" autoplay muted playsinline></video>
    </div>
    <div class="header">
      <button class="back-btn" onclick="closeScanner()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
      </button>
      <h2>Escanear</h2>
    </div>
    <div class="scanner-overlay">
      <div class="scanner-frame">
        <div class="scan-line"></div>
        <div class="scanner-corner1"></div>
        <div class="scanner-corner2"></div>
      </div>
      <p class="scanner-hint">Aponte para um QR Code ou c√≥digo de barras</p>
    </div>
    <div class="scanner-manual">
      <button class="scanner-manual-btn" onclick="manualCode()">‚úèÔ∏è Digitar c√≥digo manualmente</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HIST√ìRICO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="screen" id="history-screen">
    <div class="header">
      <h1>Hist√≥rico</h1>
      <p>Movimenta√ß√µes recentes</p>
    </div>
    <div class="scroll-content">
      <div class="hist-list" id="hist-list">
        <div class="empty"><div class="empty-icon">üìã</div><h3>Sem movimentos</h3><p>O hist√≥rico aparece aqui</p></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LISTA DE COMPRAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="screen" id="shopping-screen">
    <div class="header">
      <h1>Lista de <span style="color:var(--accent2)">Compras</span></h1>
      <p>Itens zerados ou quase acabando</p>
    </div>
    <div class="scroll-content">
      <button class="wa-btn" onclick="shareWhatsapp()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="#25d366"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
        Compartilhar no WhatsApp
      </button>
      <div class="section-title" style="padding-top:16px">Itens para comprar</div>
      <div class="product-list" id="shopping-list" style="padding:0 20px;gap:8px"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOTTOM NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <nav id="bottom-nav">
    <button class="nav-btn active" id="nav-home" onclick="showScreen('home')">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <span>In√≠cio</span>
    </button>
    <button class="nav-btn" id="nav-stock" onclick="showScreen('stock')">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
      <span>Estoque</span>
    </button>
    <button class="nav-btn scan-btn" onclick="openScanner()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7V5a2 2 0 012-2h2M17 3h2a2 2 0 012 2v2M21 17v2a2 2 0 01-2 2h-2M7 21H5a2 2 0 01-2-2v-2"/><line x1="7" y1="12" x2="7" y2="12.01"/><rect x="10" y="10" width="8" height="4" rx="1"/></svg>
    </button>
    <button class="nav-btn" id="nav-history" onclick="showScreen('history')">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      <span>Hist√≥rico</span>
    </button>
    <button class="nav-btn" id="nav-shopping" onclick="showScreen('shopping')">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 001.99-1.61L23 6H6"/></svg>
      <span>Compras</span>
    </button>
  </nav>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- Product action modal -->
<div class="modal-overlay" id="product-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div>
        <div class="modal-title" id="pm-name">Produto</div>
        <div class="modal-sub" id="pm-sub">Categoria</div>
      </div>
      <button class="modal-close" onclick="closeProductModal()">√ó</button>
    </div>
    <div class="modal-qty-display">
      <div class="modal-qty-num" id="pm-qty">0</div>
      <div class="modal-qty-label">em estoque</div>
    </div>
    <div class="quick-btns">
      <button class="quick-btn add" onclick="quickAdd(1)">+1</button>
      <button class="quick-btn add" onclick="quickAdd(3)">+3</button>
      <button class="quick-btn add" onclick="quickAdd(5)">+5</button>
    </div>
    <div class="quick-btns" style="padding-top:8px">
      <button class="quick-btn remove" onclick="quickRemove(1)">‚àí1</button>
      <button class="quick-btn add-custom" onclick="showCustomQty()">Personalizado</button>
    </div>
    <div class="divider"></div>
    <div class="input-row" id="expiry-row">
      <div class="input-label">Validade</div>
      <input type="date" class="text-input" id="pm-expiry" onchange="saveExpiryOnly()">
    </div>
    <button class="action-btn primary" onclick="closeProductModal()" style="margin-top:16px">Fechar</button>
    <button class="action-btn danger" onclick="deleteProduct()">Remover produto</button>
    <div style="height:8px"></div>
  </div>
</div>

<!-- New product modal -->
<div class="modal-overlay" id="new-product-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div>
        <div class="modal-title">Novo Produto</div>
        <div class="modal-sub" id="npm-code">C√≥digo detectado</div>
      </div>
      <button class="modal-close" onclick="closeModal('new-product-modal')">√ó</button>
    </div>
    <div class="input-row">
      <div class="input-label">Nome do produto</div>
      <input type="text" class="text-input" id="npm-name" placeholder="Ex: Ketchup Heinz 397g" autocomplete="off">
    </div>
    <div class="input-row">
      <div class="input-label">Categoria</div>
      <select class="text-input" id="npm-cat">
        <option value="Geladeira">ü•∂ Geladeira</option>
        <option value="Despensa" selected>üè† Despensa</option>
        <option value="Congelador">üßä Congelador</option>
        <option value="Bebidas">ü•§ Bebidas</option>
        <option value="Hortifruti">ü•¶ Hortifruti</option>
        <option value="Limpeza">üßπ Limpeza</option>
        <option value="Higiene">ü™• Higiene</option>
        <option value="Outros">üì¶ Outros</option>
      </select>
    </div>
    <div class="input-row">
      <div class="input-label">Quantidade inicial</div>
      <div class="stepper">
        <div class="stepper-btn" onclick="stepQty(-1)">‚àí</div>
        <div class="stepper-val" id="npm-qty">1</div>
        <div class="stepper-btn" onclick="stepQty(1)">+</div>
      </div>
    </div>
    <div class="input-row">
      <div class="input-label">Alerta de estoque baixo (opcional)</div>
      <input type="number" class="text-input" id="npm-alert" placeholder="Ex: 2" min="0">
    </div>
    <button class="action-btn primary" onclick="saveNewProduct()">Cadastrar produto</button>
    <div style="height:8px"></div>
  </div>
</div>

<!-- Custom qty modal -->
<div class="modal-overlay" id="custom-qty-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div><div class="modal-title">Quantidade</div></div>
      <button class="modal-close" onclick="closeModal('custom-qty-modal')">√ó</button>
    </div>
    <div class="input-row" style="padding-top:20px">
      <div class="input-label">Opera√ß√£o</div>
      <select class="text-input" id="cq-op">
        <option value="add">Adicionar (+)</option>
        <option value="remove">Remover (‚àí)</option>
        <option value="set">Definir quantidade</option>
      </select>
    </div>
    <div class="input-row">
      <div class="input-label">Quantidade</div>
      <input type="number" class="text-input" id="cq-val" min="0" placeholder="0">
    </div>
    <button class="action-btn primary" onclick="applyCustomQty()">Aplicar</button>
    <div style="height:8px"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DB = {
  products: JSON.parse(localStorage.getItem('dp_products') || '[]'),
  stock: JSON.parse(localStorage.getItem('dp_stock') || '{}'),
  history: JSON.parse(localStorage.getItem('dp_history') || '[]'),
  save() {
    localStorage.setItem('dp_products', JSON.stringify(this.products));
    localStorage.setItem('dp_stock', JSON.stringify(this.stock));
    localStorage.setItem('dp_history', JSON.stringify(this.history));
  }
};

const EMOJIS = {
  Geladeira:'ü•õ', Despensa:'üè†', Congelador:'üßä', Bebidas:'ü•§',
  Hortifruti:'ü•¶', Limpeza:'üßπ', Higiene:'ü™•', Outros:'üì¶'
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentScreen = 'home';

function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(name + '-screen').classList.add('active');
  const nb = document.getElementById('nav-' + name);
  if (nb) nb.classList.add('active');
  currentScreen = name;
  if (name === 'home') renderHome();
  if (name === 'stock') renderStock();
  if (name === 'history') renderHistory();
  if (name === 'shopping') renderShopping();
}

// Atualiza a tela atual sem navegar ‚Äî FIX #5
function refreshCurrentScreen() {
  if (currentScreen === 'home') renderHome();
  else if (currentScreen === 'stock') renderStock();
  else if (currentScreen === 'history') renderHistory();
  else if (currentScreen === 'shopping') renderShopping();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCANNER ‚Äî BarcodeDetector (nativo) + ZXing (fallback)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let stream = null;
let lastCode = null;
let _screenBeforeScanner = 'home';
let _zxingReader = null;
let _nativeDetector = null;
let _scanActive = false;
let _scanRafId = null;

// Inicializa detectores dispon√≠veis
async function initDetectors() {
  // Tenta BarcodeDetector nativo (Chrome/Android)
  if ('BarcodeDetector' in window) {
    try {
      const supported = await BarcodeDetector.getSupportedFormats();
      _nativeDetector = new BarcodeDetector({ formats: supported });
    } catch(e) { _nativeDetector = null; }
  }
  // Inicializa ZXing como fallback
  if (window.ZXing) {
    try {
      _zxingReader = new ZXing.BrowserMultiFormatReader();
    } catch(e) { _zxingReader = null; }
  }
}
initDetectors();

async function openScanner() {
  _screenBeforeScanner = currentScreen;
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('scanner-screen').classList.add('active');
  lastCode = null;
  _scanActive = true;

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: {ideal:'environment'}, width:{ideal:1920}, height:{ideal:1080} }
    });
    const vid = document.getElementById('scanner-video');
    vid.srcObject = stream;
    await vid.play();

    // Escolhe m√©todo de scan
    if (_nativeDetector) {
      startNativeScan(vid);
    } else if (_zxingReader) {
      startZXingScan(vid);
    } else {
      startCanvasScan(vid); // fallback manual com canvas
    }
  } catch(e) {
    showToast('C√¢mera n√£o dispon√≠vel. Use o modo manual.');
  }
}

// ‚îÄ‚îÄ M√©todo 1: BarcodeDetector nativo (Chrome/Android) ‚îÄ‚îÄ
function startNativeScan(vid) {
  const loop = async () => {
    if (!_scanActive) return;
    try {
      if (vid.readyState === vid.HAVE_ENOUGH_DATA) {
        const results = await _nativeDetector.detect(vid);
        if (results.length > 0) {
          const code = results[0].rawValue;
          if (code && code !== lastCode) {
            lastCode = code;
            stopScan();
            handleCode(code);
            return;
          }
        }
      }
    } catch(e) {}
    _scanRafId = requestAnimationFrame(loop);
  };
  _scanRafId = requestAnimationFrame(loop);
}

// ‚îÄ‚îÄ M√©todo 2: ZXing (fallback universal) ‚îÄ‚îÄ
function startZXingScan(vid) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  const hints = new Map();
  const formats = [
    ZXing.BarcodeFormat.EAN_13,
    ZXing.BarcodeFormat.EAN_8,
    ZXing.BarcodeFormat.UPC_A,
    ZXing.BarcodeFormat.UPC_E,
    ZXing.BarcodeFormat.CODE_128,
    ZXing.BarcodeFormat.CODE_39,
    ZXing.BarcodeFormat.QR_CODE,
    ZXing.BarcodeFormat.DATA_MATRIX,
    ZXing.BarcodeFormat.ITF,
  ];
  hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
  hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
  const reader = new ZXing.MultiFormatReader();
  reader.setHints(hints);

  const loop = () => {
    if (!_scanActive) return;
    try {
      if (vid.readyState === vid.HAVE_ENOUGH_DATA) {
        canvas.width = vid.videoWidth;
        canvas.height = vid.videoHeight;
        ctx.drawImage(vid, 0, 0);
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const luminance = new ZXing.RGBLuminanceSource(imgData.data, canvas.width, canvas.height);
        const binary = new ZXing.HybridBinarizer(luminance);
        const bitmap = new ZXing.BinaryBitmap(binary);
        try {
          const result = reader.decode(bitmap);
          if (result && result.getText() !== lastCode) {
            lastCode = result.getText();
            stopScan();
            handleCode(lastCode);
            return;
          }
        } catch(notFound) {} // NotFoundException √© normal quando n√£o h√° c√≥digo na cena
      }
    } catch(e) {}
    _scanRafId = requestAnimationFrame(loop);
  };
  _scanRafId = requestAnimationFrame(loop);
}

// ‚îÄ‚îÄ M√©todo 3: Canvas manual a 5fps (√∫ltimo recurso) ‚îÄ‚îÄ
let _fallbackInterval = null;
function startCanvasScan(vid) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  showToast('Modo b√°sico (s√≥ QR Code)');
  _fallbackInterval = setInterval(() => {
    if (!_scanActive || vid.readyState !== vid.HAVE_ENOUGH_DATA) return;
    canvas.width = vid.videoWidth;
    canvas.height = vid.videoHeight;
    ctx.drawImage(vid, 0, 0);
    // tenta jsQR se dispon√≠vel
    if (window.jsQR) {
      const d = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const r = jsQR(d.data, d.width, d.height, { inversionAttempts: 'attemptBoth' });
      if (r && r.data && r.data !== lastCode) {
        lastCode = r.data;
        stopScan();
        handleCode(r.data);
      }
    }
  }, 200);
}

function stopScan() {
  _scanActive = false;
  if (_scanRafId) { cancelAnimationFrame(_scanRafId); _scanRafId = null; }
  if (_fallbackInterval) { clearInterval(_fallbackInterval); _fallbackInterval = null; }
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
}

function closeScanner() {
  stopScan();
  showScreen(_screenBeforeScanner);
}

function manualCode() {
  const code = prompt('Digite o c√≥digo do produto:');
  if (code && code.trim()) {
    stopScan();
    handleCode(code.trim());
  }
}

function handleCode(code) {
  const product = DB.products.find(p => p.code === code);
  if (product) {
    // Produto encontrado: vai para in√≠cio e abre modal ‚Äî FIX #4
    showScreen('home');
    openProductModal(product);
  } else {
    // Produto desconhecido: vai para in√≠cio, abre modal de cadastro ‚Äî FIX #4
    _newQty = 1; // FIX #1: reseta qty antes de abrir modal
    document.getElementById('npm-code').textContent = code;
    document.getElementById('npm-name').value = '';
    document.getElementById('npm-qty').textContent = '1';
    document.getElementById('npm-alert').value = '';
    document.getElementById('npm-cat').value = 'Despensa';
    window._pendingCode = code;
    showScreen('home');
    openModal('new-product-modal');
    setTimeout(() => document.getElementById('npm-name').focus(), 350);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PRODUCT MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _activeProduct = null;

// Debounce para consolidar cliques r√°pidos no hist√≥rico ‚Äî FIX #7
let _pendingHistEntry = null;   // {pid, type, delta, timer}

function flushHistory() {
  if (!_pendingHistEntry) return;
  clearTimeout(_pendingHistEntry.timer);
  if (_pendingHistEntry.delta !== 0) {
    DB.history.unshift({
      pid: _pendingHistEntry.pid,
      type: _pendingHistEntry.type,
      qty: Math.abs(_pendingHistEntry.delta),
      date: new Date().toISOString()
    });
    DB.save();
  }
  _pendingHistEntry = null;
}

function scheduleHistory(pid, type, delta) {
  // Se j√° tem pendente para o mesmo produto e tipo, acumula
  if (_pendingHistEntry && _pendingHistEntry.pid === pid && _pendingHistEntry.type === type) {
    clearTimeout(_pendingHistEntry.timer);
    _pendingHistEntry.delta += delta;
  } else {
    // Outro produto/tipo: salva o anterior imediatamente
    flushHistory();
    _pendingHistEntry = { pid, type, delta };
  }
  // Aguarda 1.5s sem cliques para registrar
  _pendingHistEntry.timer = setTimeout(flushHistory, 1500);
}

function handleProductClick(el) {
  const id = el.dataset.pid;
  const product = DB.products.find(p => p.id === id);
  if (product) openProductModal(product);
}

function openProductModal(product) {
  // Garante que flushamos hist√≥rico pendente de qualquer produto anterior ‚Äî FIX #7/#8
  flushHistory();
  _activeProduct = product;
  const qty = DB.stock[product.id] ?? 0;
  document.getElementById('pm-name').textContent = product.name;
  document.getElementById('pm-sub').textContent = `${EMOJIS[product.cat] || 'üì¶'} ${product.cat}  ‚Ä¢  C√≥digo: ${product.code}`;
  document.getElementById('pm-qty').textContent = qty;
  document.getElementById('pm-qty').className = 'modal-qty-num ' + qtyClass(qty, product.alert);
  document.getElementById('pm-expiry').value = product.expiry || '';
  // Mostra/esconde validade quando zerado ‚Äî FIX #2
  document.getElementById('expiry-row').style.display = qty === 0 ? 'none' : '';
  openModal('product-modal');
}

function updateModalQty(newQty) {
  document.getElementById('pm-qty').textContent = newQty;
  document.getElementById('pm-qty').className = 'modal-qty-num ' + qtyClass(newQty, _activeProduct.alert);
  // Esconde validade se zerou ‚Äî FIX #2
  document.getElementById('expiry-row').style.display = newQty === 0 ? 'none' : '';
  if (newQty === 0) {
    // Limpa a validade ao zerar ‚Äî FIX #2
    _activeProduct.expiry = '';
    document.getElementById('pm-expiry').value = '';
    const idx = DB.products.findIndex(p => p.id === _activeProduct.id);
    if (idx >= 0) DB.products[idx].expiry = '';
  }
}

function quickAdd(n) {
  if (!_activeProduct) return;
  DB.stock[_activeProduct.id] = (DB.stock[_activeProduct.id] || 0) + n;
  const qty = DB.stock[_activeProduct.id];
  DB.save(); // FIX #8: salva imediatamente
  updateModalQty(qty);
  scheduleHistory(_activeProduct.id, 'entry', n); // FIX #7: acumula no hist√≥rico
  refreshCurrentScreen(); // FIX #5: atualiza tela de fundo
  showToast(`+${n} ¬∑ ${_activeProduct.name} (${qty})`);
}

function quickRemove(n) {
  if (!_activeProduct) return;
  const curr = DB.stock[_activeProduct.id] || 0;
  const newQty = Math.max(0, curr - n);
  const removed = curr - newQty;
  DB.stock[_activeProduct.id] = newQty;
  DB.save(); // FIX #8: salva imediatamente
  updateModalQty(newQty);
  if (removed > 0) scheduleHistory(_activeProduct.id, 'exit', removed); // FIX #7
  refreshCurrentScreen(); // FIX #5
  showToast(`‚àí${removed} ¬∑ ${_activeProduct.name} (${newQty})`);
}

function showCustomQty() {
  document.getElementById('cq-val').value = '';
  openModal('custom-qty-modal');
}

function applyCustomQty() {
  if (!_activeProduct) return;
  const op = document.getElementById('cq-op').value;
  const val = parseInt(document.getElementById('cq-val').value) || 0;
  const curr = DB.stock[_activeProduct.id] || 0;
  let newQty, histQty, histType;
  if (op === 'add') { newQty = curr + val; histQty = val; histType = 'entry'; }
  else if (op === 'remove') { newQty = Math.max(0, curr - val); histQty = curr - newQty; histType = 'exit'; }
  else { newQty = Math.max(0, val); histQty = Math.abs(newQty - curr); histType = newQty >= curr ? 'entry' : 'exit'; }
  flushHistory(); // FIX #7: garante que pendente anterior foi salvo
  DB.stock[_activeProduct.id] = newQty;
  if (histQty > 0) DB.history.unshift({pid: _activeProduct.id, type:histType, qty:histQty, date: new Date().toISOString()});
  DB.save(); // FIX #8
  closeModal('custom-qty-modal');
  updateModalQty(newQty);
  refreshCurrentScreen(); // FIX #5
  showToast(`Estoque atualizado: ${newQty}`);
}

function saveExpiryOnly() {
  if (!_activeProduct) return;
  _activeProduct.expiry = document.getElementById('pm-expiry').value;
  const idx = DB.products.findIndex(p => p.id === _activeProduct.id);
  if (idx >= 0) DB.products[idx].expiry = _activeProduct.expiry;
  DB.save();
  refreshCurrentScreen();
  showToast('Validade salva!');
}

function closeProductModal() {
  if (!_activeProduct) return;
  flushHistory();
  _activeProduct.expiry = document.getElementById('pm-expiry').value;
  const idx = DB.products.findIndex(p => p.id === _activeProduct.id);
  if (idx >= 0) DB.products[idx].expiry = _activeProduct.expiry;
  DB.save();
  closeModal('product-modal');
  refreshCurrentScreen();
}

function deleteProduct() {
  if (!_activeProduct || !confirm(`Remover "${_activeProduct.name}"?`)) return;
  flushHistory();
  DB.products = DB.products.filter(p => p.id !== _activeProduct.id);
  delete DB.stock[_activeProduct.id];
  DB.save();
  closeModal('product-modal');
  refreshCurrentScreen(); // FIX #5
  showToast('Produto removido');
}

// Fechar clicando fora do modal
document.getElementById('product-modal').addEventListener('click', function(e) {
  if (e.target === this) closeProductModal();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NEW PRODUCT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _newQty = 1; // FIX #1: vari√°vel isolada, resetada em handleCode

function stepQty(delta) {
  _newQty = Math.max(0, _newQty + delta); // FIX #1: usa _newQty limpo, sem depender de estado anterior
  document.getElementById('npm-qty').textContent = _newQty;
}

function saveNewProduct() {
  const name = document.getElementById('npm-name').value.trim();
  if (!name) { document.getElementById('npm-name').focus(); showToast('Digite o nome do produto'); return; }
  const cat = document.getElementById('npm-cat').value;
  const qty = _newQty; // FIX #1: usa vari√°vel local, n√£o o texto do DOM
  const alertVal = parseInt(document.getElementById('npm-alert').value) || 0;
  const code = window._pendingCode || Date.now().toString();
  const id = 'p' + Date.now();
  DB.products.push({id, code, name, cat, alert: alertVal, expiry:''});
  DB.stock[id] = qty;
  if (qty > 0) DB.history.unshift({pid: id, type:'entry', qty, date: new Date().toISOString()});
  DB.save();
  window._pendingCode = null;
  _newQty = 1; // FIX #1: reset ap√≥s salvar
  closeModal('new-product-modal');
  showToast(`‚úì "${name}" cadastrado!`);
  // Sempre vai para in√≠cio ap√≥s cadastro ‚Äî FIX #4
  showScreen('home');
  renderCatTabs();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function qtyClass(qty, alert=2) {
  if (qty === 0) return 'zero';
  if (qty <= (alert || 2)) return 'low';
  return 'ok';
}

function renderHome() {
  const today = new Date();
  document.getElementById('home-date').textContent = today.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long'});

  const total = DB.products.length;
  const empty = DB.products.filter(p => (DB.stock[p.id]||0) === 0).length;
  const low = DB.products.filter(p => { const q=DB.stock[p.id]||0; return q>0 && q<=(p.alert||2); }).length;
  const ok = total - empty - low;
  document.getElementById('stat-total').textContent = total;
  document.getElementById('stat-ok').textContent = ok;
  document.getElementById('stat-low').textContent = low;
  document.getElementById('stat-empty').textContent = empty;

  // alerts
  const alerts = DB.products.filter(p => (DB.stock[p.id]||0) <= (p.alert||2));
  const alertsEl = document.getElementById('alerts-list');
  const alertsTitle = document.getElementById('alerts-title');
  if (alerts.length) {
    alertsTitle.style.display = '';
    alertsEl.innerHTML = alerts.slice(0,5).map(p => {
      const q = DB.stock[p.id]||0;
      return `<div class="alert-item" data-pid="${p.id}" onclick="handleProductClick(this)">
        <div class="alert-dot"></div>
        <div class="alert-name">${p.name}</div>
        <div class="alert-qty">${q === 0 ? 'ZERADO' : `s√≥ ${q}`}</div>
      </div>`;
    }).join('');
  } else {
    alertsTitle.style.display = 'none';
    alertsEl.innerHTML = '';
  }

  // recent (last 6 moved)
  const recentEl = document.getElementById('recent-list');
  const recent = [...DB.products].sort((a,b) => {
    const ah = DB.history.findIndex(h => h.pid === a.id);
    const bh = DB.history.findIndex(h => h.pid === b.id);
    return (ah === -1 ? 9999 : ah) - (bh === -1 ? 9999 : bh);
  }).slice(0, 6);

  if (DB.products.length === 0) {
    recentEl.innerHTML = `<div class="empty"><div class="empty-icon">üõí</div><h3>Estoque vazio</h3><p>Escaneie um produto para come√ßar</p></div>`;
  } else {
    recentEl.innerHTML = recent.map(p => productItemHTML(p)).join('');
  }
}

function productItemHTML(p) {
  const qty = DB.stock[p.id] || 0;
  const qc = qtyClass(qty, p.alert);
  let expBadge = '';
  // FIX #2: n√£o exibe validade se zerado
  if (p.expiry && qty > 0) {
    const diff = (new Date(p.expiry) - new Date()) / 86400000;
    if (diff < 0) expBadge = `<span class="expiry-badge expiry-expired">Vencido</span>`;
    else if (diff < 7) expBadge = `<span class="expiry-badge expiry-soon">Vence em ${Math.ceil(diff)}d</span>`;
    else expBadge = `<span class="expiry-badge expiry-ok">Val. ${new Date(p.expiry).toLocaleDateString('pt-BR')}</span>`;
  }
  return `<div class="product-item" data-pid="${p.id}" onclick="handleProductClick(this)">
    <div class="product-emoji">${EMOJIS[p.cat]||'üì¶'}</div>
    <div class="product-info">
      <div class="product-name">${p.name}</div>
      <div class="product-cat">${p.cat}${expBadge ? ' ¬∑ '+expBadge : ''}</div>
    </div>
    <div class="product-qty">
      <div class="qty-num ${qc}">${qty}</div>
      <div class="qty-label">unid.</div>
    </div>
  </div>`;
}

// Stock screen
let _filterCat = 'Todos';
let _filterText = '';

function renderCatTabs() {
  const cats = ['Todos', ...new Set(DB.products.map(p=>p.cat))];
  const tabs = document.getElementById('cat-tabs');
  tabs.innerHTML = cats.map(c =>
    `<button class="cat-tab${c===_filterCat?' active':''}" onclick="filterCat('${c}',this)">${c}</button>`
  ).join('');
}

function filterCat(cat, btn) {
  _filterCat = cat;
  document.querySelectorAll('.cat-tab').forEach(b=>b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderStock();
}

function filterProducts() {
  _filterText = document.getElementById('search-input').value.toLowerCase();
  renderStock();
}

function renderStock() {
  renderCatTabs();
  let products = DB.products;
  if (_filterCat !== 'Todos') products = products.filter(p=>p.cat===_filterCat);
  if (_filterText) products = products.filter(p=>p.name.toLowerCase().includes(_filterText));
  products.sort((a,b) => a.name.localeCompare(b.name));
  const el = document.getElementById('stock-list');
  if (products.length === 0) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">üîç</div><h3>Nenhum produto</h3><p>Tente outro filtro ou escaneie algo novo</p></div>`;
  } else {
    el.innerHTML = products.map(p => productItemHTML(p)).join('');
  }
}

function renderHistory() {
  const el = document.getElementById('hist-list');
  if (DB.history.length === 0) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">üìã</div><h3>Sem movimentos</h3><p>O hist√≥rico aparece aqui</p></div>`;
    return;
  }
  el.innerHTML = DB.history.slice(0, 100).map(h => {
    const p = DB.products.find(x=>x.id===h.pid);
    const name = p ? p.name : 'Produto removido';
    const date = new Date(h.date).toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
    const icon = h.type==='entry' ? 'üì•' : 'üì§';
    const sign = h.type==='entry' ? '+' : '‚àí';
    return `<div class="hist-item">
      <div class="hist-icon ${h.type}">${icon}</div>
      <div class="hist-info">
        <div class="hist-name">${name}</div>
        <div class="hist-date">${date}</div>
      </div>
      <div class="hist-qty ${h.type}">${sign}${h.qty}</div>
    </div>`;
  }).join('');
}

// FIX #6: set de marcados; se vazio ‚Üí envia todos
let _shoppingChecked = new Set();

function renderShopping() {
  const items = DB.products.filter(p => (DB.stock[p.id]||0) <= (p.alert||2)).sort((a,b)=>a.cat.localeCompare(b.cat));
  const el = document.getElementById('shopping-list');
  if (items.length === 0) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">‚úÖ</div><h3>Tudo em ordem!</h3><p>Nenhum item para comprar no momento</p></div>`;
    return;
  }
  el.innerHTML = items.map(p => {
    const checked = _shoppingChecked.has(p.id);
    const qty = DB.stock[p.id]||0;
    return `<div class="shopping-item${checked?' checked':''}" onclick="toggleShoppingCheck('${p.id}')">
      <div class="check-circle">${checked?'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>':''}</div>
      <div class="product-emoji" style="width:38px;height:38px;font-size:18px">${EMOJIS[p.cat]||'üì¶'}</div>
      <div class="product-info">
        <div class="product-name">${p.name}</div>
        <div class="product-cat">${p.cat} ¬∑ ${qty===0?'<span style="color:var(--red)">Zerado</span>':'<span style="color:var(--yellow)">S√≥ '+qty+'</span>'}</div>
      </div>
    </div>`;
  }).join('');
}

function toggleShoppingCheck(id) {
  if (_shoppingChecked.has(id)) _shoppingChecked.delete(id);
  else _shoppingChecked.add(id);
  renderShopping();
}

function shareWhatsapp() {
  // FIX #6: se algum marcado ‚Üí envia s√≥ marcados; sen√£o envia todos
  const allItems = DB.products.filter(p => (DB.stock[p.id]||0) <= (p.alert||2));
  if (!allItems.length) { showToast('Nenhum item para comprar!'); return; }
  const toSend = _shoppingChecked.size > 0
    ? allItems.filter(p => _shoppingChecked.has(p.id))
    : allItems;
  if (!toSend.length) { showToast('Nenhum item selecionado!'); return; }
  const lines = toSend.map(p => {
    const q = DB.stock[p.id]||0;
    return `‚Ä¢ ${p.name}${q===0?' (ZERADO)':' ('+q+' restante)'}`;
  });
  const text = `üõí *Lista de Compras*\n\n${lines.join('\n')}\n\n_Gerado pelo app Despensa_`;
  window.open('https://wa.me/?text=' + encodeURIComponent(text));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id) {
  document.getElementById(id).classList.add('open');
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}
// close on overlay click (exceto product-modal que tem handler pr√≥prio)
document.querySelectorAll('.modal-overlay').forEach(ov => {
  if (ov.id === 'product-modal') return;
  ov.addEventListener('click', e => { if (e.target === ov) closeModal(ov.id); });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
renderHome();
renderCatTabs();

// Register service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(()=>{});
}
</script>
</body>
</html>
