<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#1a1a2e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Despensa">
<link rel="manifest" href="/estoque-manager/manifest.json">
<link rel="apple-touch-icon" href="/estoque-manager/icon-192.png">
<!-- Firebase -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
  import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, deleteDoc, updateDoc, serverTimestamp, arrayUnion } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyA8ni95LymF-eW0iI0e5wDYzVdjna0Cb3Y",
    authDomain: "despensa-5ca8c.firebaseapp.com",
    projectId: "despensa-5ca8c",
    storageBucket: "despensa-5ca8c.firebasestorage.app",
    messagingSenderId: "181972573190",
    appId: "1:181972573190:web:e2ef11023c17cefd293787"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const googleProvider = new GoogleAuthProvider();

  // Exp√µe para o c√≥digo global
  window._FB = { auth, db, doc, setDoc, getDoc, onSnapshot, collection, addDoc, deleteDoc, updateDoc, serverTimestamp, arrayUnion, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, googleProvider };
</script>
<title>Despensa</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f1a;
    --bg2: #16162a;
    --bg3: #1e1e35;
    --card: #1a1a30;
    --card2: #22223a;
    --accent: #7c6af7;
    --accent2: #a78bfa;
    --accent3: #c4b5fd;
    --green: #34d399;
    --yellow: #fbbf24;
    --red: #f87171;
    --text: #f0eeff;
    --text2: #a0a0c0;
    --text3: #6060a0;
    --border: rgba(124,106,247,0.18);
    --glow: 0 0 30px rgba(124,106,247,0.15);
    --r: 16px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  html, body {
    height: 100%;
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    overflow: hidden;
  }

  /* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
  #app {
    height: 100dvh;
    display: flex;
    flex-direction: column;
    max-width: 480px;
    margin: 0 auto;
    position: relative;
    overflow: hidden;
  }

  /* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
  .screen {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    opacity: 0;
    pointer-events: none;
    transition: opacity .25s ease, transform .25s ease;
    transform: translateY(8px);
    overflow: hidden;
  }
  .screen.active {
    opacity: 1;
    pointer-events: all;
    transform: translateY(0);
  }

  /* ‚îÄ‚îÄ SCROLLABLE CONTENT ‚îÄ‚îÄ */
  .scroll-content {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 110px;
  }
  .scroll-content::-webkit-scrollbar { display: none; }

  /* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
  #bottom-nav {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 480px;
    background: rgba(15,15,26,0.95);
    backdrop-filter: blur(20px);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 8px 0;
    height: 72px;
    z-index: 100;
    /* escudo: bloqueia qualquer toque que n√£o seja nos pr√≥prios bot√µes */
    pointer-events: none;
  }
  #bottom-nav > * {
    pointer-events: all;
  }
  .nav-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    height: 60px;
    border-radius: 12px;
    border: none;
    background: transparent;
    color: var(--text3);
    font-family: 'DM Sans', sans-serif;
    font-size: 10px;
    font-weight: 500;
    letter-spacing: .04em;
    cursor: pointer;
    transition: all .2s;
    position: relative;
  }
  .nav-btn svg { transition: all .2s; }
  .nav-btn.active { color: var(--accent2); }
  .nav-btn.active svg { filter: drop-shadow(0 0 6px var(--accent)); }
  .nav-btn.scan-btn {
    background: linear-gradient(135deg, var(--accent) 0%, #a78bfa 100%);
    color: white;
    box-shadow: 0 4px 20px rgba(124,106,247,0.45);
    flex: none;
    width: 56px;
    height: 56px;
    border-radius: 18px;
    margin: 0 8px;
  }
  .nav-btn.scan-btn svg { width: 26px; height: 26px; }
  .nav-btn span { font-size: 10px; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .header {
    padding: 52px 20px 16px;
    background: linear-gradient(180deg, var(--bg) 0%, transparent 100%);
    position: relative;
    z-index: 10;
  }
  .header h1 {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 28px;
    color: var(--text);
    letter-spacing: -.02em;
  }
  .header h1 span { color: var(--accent2); }
  .header p { color: var(--text2); font-size: 13px; margin-top: 2px; }

  /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 16px;
  }
  .card-lg {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 20px;
  }

  /* ‚îÄ‚îÄ HOME SCREEN ‚îÄ‚îÄ */
  .home-stats {
    padding: 4px 20px 0;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 16px;
    position: relative;
    overflow: hidden;
  }
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    border-radius: 2px 2px 0 0;
  }
  .stat-card.purple::before { background: linear-gradient(90deg, var(--accent), var(--accent2)); }
  .stat-card.green::before { background: linear-gradient(90deg, var(--green), #6ee7b7); }
  .stat-card.yellow::before { background: linear-gradient(90deg, var(--yellow), #fde68a); }
  .stat-card.red::before { background: linear-gradient(90deg, var(--red), #fca5a5); }
  .stat-num {
    font-family: 'Syne', sans-serif;
    font-size: 32px;
    font-weight: 800;
    line-height: 1;
  }
  .stat-label { color: var(--text2); font-size: 11px; margin-top: 4px; text-transform: uppercase; letter-spacing: .06em; }

  .section-title {
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .1em;
    color: var(--text3);
    padding: 20px 20px 10px;
  }

  /* ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ */
  .alert-list { padding: 0 20px; display: flex; flex-direction: column; gap: 8px; }
  .alert-item {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--card);
    border: 1px solid rgba(251,191,36,0.2);
    border-radius: 12px;
    padding: 12px 14px;
  }
  .alert-item.zero { border-color: rgba(248,113,113,0.2); }
  .alert-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--yellow); flex-shrink: 0; box-shadow: 0 0 8px var(--yellow); }
  .alert-item.zero .alert-dot { background: var(--red); box-shadow: 0 0 8px var(--red); }
  .alert-name { font-size: 13px; font-weight: 500; flex: 1; }
  .alert-qty { font-size: 12px; color: var(--yellow); font-weight: 600; }
  .alert-item.zero .alert-qty { color: var(--red); }

  /* ‚îÄ‚îÄ ESTOQUE SCREEN ‚îÄ‚îÄ */
  .search-wrap { padding: 0 20px 12px; }
  .search-input {
    width: 100%;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px 16px 12px 44px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    outline: none;
    transition: border-color .2s;
    position: relative;
  }
  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--text3); }
  .search-wrap { position: relative; }
  .search-icon {
    position: absolute;
    left: 32px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text3);
  }

  /* category tabs */
  .cat-tabs {
    display: flex;
    gap: 8px;
    padding: 0 20px 14px;
    overflow-x: auto;
    scrollbar-width: none;
  }
  .cat-tabs::-webkit-scrollbar { display: none; }
  .cat-tab {
    flex-shrink: 0;
    padding: 7px 16px;
    border-radius: 100px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text2);
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all .2s;
    white-space: nowrap;
  }
  .cat-tab.active {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
    box-shadow: 0 2px 12px rgba(124,106,247,0.4);
  }

  .product-list { padding: 0 20px; display: flex; flex-direction: column; gap: 8px; }
  .product-item {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px;
    transition: all .2s;
    cursor: pointer;
    animation: slideIn .25s ease forwards;
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .product-item:active { transform: scale(.98); }
  .product-emoji {
    width: 42px; height: 42px;
    border-radius: 12px;
    background: var(--card2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    flex-shrink: 0;
  }
  .product-info { flex: 1; min-width: 0; }
  .product-name { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .product-cat { font-size: 11px; color: var(--text2); margin-top: 2px; }
  .product-qty {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
  }
  .qty-num {
    font-family: 'Syne', sans-serif;
    font-size: 20px;
    font-weight: 700;
    line-height: 1;
  }
  .qty-num.zero { color: var(--red); }
  .qty-num.low { color: var(--yellow); }
  .qty-num.ok { color: var(--green); }
  .qty-label { font-size: 10px; color: var(--text3); text-transform: uppercase; letter-spacing: .04em; }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(10,10,20,0.85);
    backdrop-filter: blur(8px);
    z-index: 200;
    display: flex;
    align-items: flex-end;
    opacity: 0;
    pointer-events: none;
    transition: opacity .25s;
  }
  .modal-overlay.open {
    opacity: 1;
    pointer-events: all;
  }
  .modal {
    width: 100%;
    max-width: 480px;
    margin: 0 auto;
    background: var(--bg2);
    border-radius: 24px 24px 0 0;
    border: 1px solid var(--border);
    border-bottom: none;
    padding: 0 0 32px;
    transform: translateY(100%);
    transition: transform .3s cubic-bezier(0.34,1.56,0.64,1);
    max-height: 90dvh;
    overflow-y: auto;
  }
  .modal-overlay.open .modal {
    transform: translateY(0);
  }
  .modal-handle {
    width: 40px; height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin: 12px auto 0;
  }
  .modal-header {
    padding: 20px 20px 0;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 12px;
  }
  .modal-title {
    font-family: 'Syne', sans-serif;
    font-size: 20px;
    font-weight: 800;
  }
  .modal-sub { color: var(--text2); font-size: 13px; margin-top: 3px; }
  .modal-close {
    width: 32px; height: 32px;
    border-radius: 50%;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text2);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
    font-size: 18px;
  }

  /* quick actions in modal */
  .quick-btns {
    display: flex;
    gap: 8px;
    padding: 20px 20px 0;
  }
  .quick-btn {
    flex: 1;
    padding: 14px 0;
    border-radius: 14px;
    border: none;
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all .15s;
  }
  .quick-btn:active { transform: scale(.95); }
  .quick-btn.add { background: linear-gradient(135deg, var(--accent), var(--accent2)); color: white; box-shadow: 0 4px 16px rgba(124,106,247,0.35); }
  .quick-btn.remove { background: var(--card2); color: var(--text); border: 1px solid var(--border); }
  .quick-btn.add-custom { background: var(--card2); color: var(--accent2); border: 1px solid var(--border); font-size: 13px; }

  /* big qty display */
  .modal-qty-display {
    text-align: center;
    padding: 24px 0 8px;
  }
  .modal-qty-num {
    font-family: 'Syne', sans-serif;
    font-size: 64px;
    font-weight: 800;
    line-height: 1;
  }
  .modal-qty-label { color: var(--text2); font-size: 13px; margin-top: 4px; }

  .divider {
    height: 1px;
    background: var(--border);
    margin: 20px 20px 0;
  }

  /* input */
  .input-row { padding: 16px 20px 0; display: flex; flex-direction: column; gap: 8px; }
  .input-label { font-size: 12px; color: var(--text2); text-transform: uppercase; letter-spacing: .06em; }
  .text-input {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 16px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    outline: none;
    transition: border-color .2s;
    width: 100%;
  }
  .text-input:focus { border-color: var(--accent); }
  .text-input::placeholder { color: var(--text3); }
  select.text-input { cursor: pointer; }
  select.text-input option { background: var(--bg2); }

  .action-btn {
    width: calc(100% - 40px);
    margin: 16px 20px 0;
    padding: 16px;
    border-radius: 14px;
    border: none;
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all .15s;
  }
  .action-btn.primary {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: white;
    box-shadow: 0 4px 20px rgba(124,106,247,0.35);
  }
  .action-btn.danger { background: rgba(248,113,113,0.15); color: var(--red); border: 1px solid rgba(248,113,113,0.3); }
  .action-btn:active { transform: scale(.98); }

  /* ‚îÄ‚îÄ SCANNER OVERLAY (isolado, fora do #app) ‚îÄ‚îÄ */
  @keyframes scanMove {
    0%, 100% { top: 4px; }
    50% { top: calc(100% - 6px); }
  }

  /* ‚îÄ‚îÄ HISTORICO ‚îÄ‚îÄ */
  .hist-list { padding: 0 20px; display: flex; flex-direction: column; gap: 8px; }
  .hist-item {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px 14px;
  }
  .hist-icon {
    width: 36px; height: 36px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }
  .hist-icon.entry { background: rgba(52,211,153,0.15); }
  .hist-icon.exit { background: rgba(248,113,113,0.1); }
  .hist-info { flex: 1; min-width: 0; }
  .hist-name { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .hist-date { font-size: 11px; color: var(--text2); margin-top: 2px; }
  .hist-qty { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; }
  .hist-qty.entry { color: var(--green); }
  .hist-qty.exit { color: var(--red); }

  /* ‚îÄ‚îÄ LISTA DE COMPRAS ‚îÄ‚îÄ */
  .shopping-item {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px;
    cursor: pointer;
    transition: all .2s;
  }
  .shopping-item.checked {
    opacity: .5;
  }
  .check-circle {
    width: 22px; height: 22px;
    border-radius: 50%;
    border: 2px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    transition: all .2s;
  }
  .shopping-item.checked .check-circle {
    background: var(--accent);
    border-color: var(--accent);
  }

  /* toast */
  .toast {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--card2);
    border: 1px solid var(--border);
    border-radius: 100px;
    padding: 10px 20px;
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
    z-index: 500;
    opacity: 0;
    pointer-events: none;
    transition: all .3s;
    white-space: nowrap;
    max-width: calc(100% - 40px);
  }
  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* empty state */
  .empty {
    text-align: center;
    padding: 60px 40px;
    color: var(--text3);
  }
  .empty-icon { font-size: 48px; margin-bottom: 12px; }
  .empty h3 { font-family: 'Syne', sans-serif; font-size: 18px; color: var(--text2); margin-bottom: 6px; }
  .empty p { font-size: 13px; line-height: 1.6; }

  /* FAB */
  .fab {
    position: absolute;
    bottom: 84px;
    right: 20px;
    width: 48px; height: 48px;
    border-radius: 16px;
    background: var(--card2);
    border: 1px solid var(--border);
    color: var(--accent2);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    transition: all .2s;
    z-index: 50;
  }
  .fab:active { transform: scale(.92); }

  /* badge */
  .badge {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 100px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .05em;
  }
  .badge.cat {
    background: rgba(124,106,247,0.15);
    color: var(--accent2);
  }

  /* expiry */
  .expiry-badge {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 100px;
    font-weight: 600;
  }
  .expiry-ok { background: rgba(52,211,153,0.15); color: var(--green); }
  .expiry-soon { background: rgba(251,191,36,0.15); color: var(--yellow); }
  .expiry-expired { background: rgba(248,113,113,0.15); color: var(--red); }

  /* whatsapp share */
  .wa-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    width: calc(100% - 40px);
    margin: 12px 20px 0;
    padding: 14px 20px;
    border-radius: 14px;
    border: none;
    background: rgba(37,211,102,0.12);
    border: 1px solid rgba(37,211,102,0.25);
    color: #25d366;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all .15s;
  }
  .wa-btn:active { transform: scale(.98); }

  /* number stepper */
  .stepper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    padding: 16px 20px 0;
  }
  .stepper-btn {
    width: 44px; height: 44px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    font-size: 22px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: all .15s;
    user-select: none;
  }
  .stepper-btn:active { transform: scale(.92); background: var(--card2); }
  .stepper-val {
    font-family: 'Syne', sans-serif;
    font-size: 32px;
    font-weight: 800;
    width: 60px;
    text-align: center;
  }

  /* progress bar */
  .progress-bar {
    height: 3px;
    background: var(--bg3);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 6px;
  }
  .progress-fill {
    height: 100%;
    border-radius: 2px;
    transition: width .4s ease;
  }


  /* ‚îÄ‚îÄ VER HIST√ìRICO btn ‚îÄ‚îÄ */
  .see-all-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: calc(100% - 40px);
    margin: 12px 20px 4px;
    padding: 13px;
    border-radius: 12px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text2);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all .2s;
  }
  .see-all-btn:active { background: var(--card); }

  /* ‚îÄ‚îÄ EM USO screen ‚îÄ‚îÄ */
  .inuse-item {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px;
    animation: slideIn .25s ease forwards;
  }
  .inuse-delete {
    width: 34px; height: 34px;
    border-radius: 10px;
    border: 1px solid rgba(248,113,113,0.3);
    background: rgba(248,113,113,0.08);
    color: var(--red);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
    transition: all .15s;
  }
  .inuse-delete:active { transform: scale(.9); }
  .confirm-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    z-index: 500;
    display: none;
    align-items: flex-end;
    justify-content: center;
    padding-bottom: 24px;
  }
  .confirm-modal-overlay.open {
    display: flex;
  }
  .confirm-modal {
    background: var(--card2);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 28px 24px 20px;
    width: calc(100% - 32px);
    max-width: 440px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    animation: slideUp .25s ease forwards;
  }
  .confirm-modal-icon {
    width: 52px; height: 52px;
    border-radius: 16px;
    background: rgba(248,113,113,0.12);
    border: 1px solid rgba(248,113,113,0.25);
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 4px;
  }
  .confirm-modal-title {
    font-family: 'Syne', sans-serif;
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
  }
  .confirm-modal-desc {
    font-size: 13px;
    color: var(--text2);
    line-height: 1.5;
    margin-bottom: 8px;
  }
  .confirm-modal-btns {
    display: flex;
    gap: 10px;
    margin-top: 4px;
  }
  .confirm-modal-btns .btn-cancel {
    flex: 1;
    padding: 14px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text2);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all .15s;
  }
  .confirm-modal-btns .btn-cancel:active { background: var(--card); }
  .confirm-modal-btns .btn-confirm {
    flex: 1;
    padding: 14px;
    border-radius: 14px;
    border: none;
    background: rgba(248,113,113,0.15);
    color: var(--red);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all .15s;
    border: 1px solid rgba(248,113,113,0.3);
  }
  .confirm-modal-btns .btn-confirm:active { background: rgba(248,113,113,0.25); }

  .clear-all-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: calc(100% - 40px);
    margin: 0 20px 12px;
    padding: 13px;
    border-radius: 12px;
    background: rgba(248,113,113,0.08);
    border: 1px solid rgba(248,113,113,0.25);
    color: var(--red);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all .2s;
  }
  .clear-all-btn:active { background: rgba(248,113,113,0.15); }


  /* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
  #auth-screen {
    position: fixed;
    inset: 0;
    z-index: 200;
    background: var(--bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 32px 24px;
  }
  #auth-screen.hidden { display: none; }
  .auth-logo {
    width: 80px; height: 80px;
    border-radius: 24px;
    margin-bottom: 24px;
    box-shadow: 0 8px 32px rgba(124,106,247,0.4);
  }
  .auth-title {
    font-family: 'Syne', sans-serif;
    font-size: 28px;
    font-weight: 800;
    color: var(--text);
    margin-bottom: 6px;
    text-align: center;
  }
  .auth-title span { color: var(--accent2); }
  .auth-sub {
    font-size: 13px;
    color: var(--text2);
    margin-bottom: 32px;
    text-align: center;
  }
  .auth-tabs {
    display: flex;
    background: var(--card);
    border-radius: 12px;
    padding: 4px;
    gap: 4px;
    margin-bottom: 24px;
    width: 100%;
    max-width: 380px;
  }
  .auth-tab {
    flex: 1;
    padding: 10px;
    border-radius: 9px;
    border: none;
    background: transparent;
    color: var(--text2);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all .2s;
  }
  .auth-tab.active {
    background: var(--accent);
    color: white;
  }
  .auth-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    max-width: 380px;
  }
  .auth-input {
    width: 100%;
    padding: 14px 16px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    outline: none;
    box-sizing: border-box;
    transition: border-color .2s;
  }
  .auth-input:focus { border-color: var(--accent); }
  .auth-btn {
    padding: 15px;
    border-radius: 14px;
    border: none;
    background: linear-gradient(135deg, var(--accent), #a78bfa);
    color: white;
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 4px;
    transition: opacity .2s;
  }
  .auth-btn:active { opacity: .85; }
  .auth-btn:disabled { opacity: .5; cursor: not-allowed; }
  .auth-divider {
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text3);
    font-size: 12px;
    margin: 4px 0;
  }
  .auth-divider::before, .auth-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }
  .auth-google-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 13px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background .2s;
  }
  .auth-google-btn:active { background: var(--card2); }
  .auth-error {
    color: var(--red);
    font-size: 12px;
    text-align: center;
    min-height: 16px;
  }
  /* User bar no topo do app */
  #user-bar {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 12px 20px 0;
    gap: 10px;
    position: relative;
    z-index: 10;
    flex-shrink: 0;
  }
  #user-bar span {
    font-size: 12px;
    color: var(--text);
    font-weight: 500;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .signout-btn {
    padding: 6px 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
    position: relative;
    z-index: 10;
  }
  /* Sync indicator */
  #sync-indicator {
    position: fixed;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--card2);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 6px 14px;
    font-size: 11px;
    color: var(--text2);
    z-index: 150;
    display: none;
    gap: 6px;
    align-items: center;
  }
  #sync-indicator.show { display: flex; }


  /* ‚îÄ‚îÄ MEMBERS MODAL ‚îÄ‚îÄ */
  .members-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    z-index: 500;
    display: none;
    align-items: flex-end;
    justify-content: center;
    padding-bottom: 24px;
  }
  .members-modal-overlay.open { display: flex; }
  .members-modal {
    background: var(--card2);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 24px;
    width: calc(100% - 32px);
    max-width: 440px;
    animation: slideUp .25s ease forwards;
    max-height: 80vh;
    overflow-y: auto;
  }
  .members-modal-title {
    font-family: 'Syne', sans-serif;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 4px;
  }
  .members-modal-sub {
    font-size: 12px;
    color: var(--text2);
    margin-bottom: 20px;
  }
  .invite-code-box {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 16px;
    margin-bottom: 16px;
  }
  .invite-code-label {
    font-size: 11px;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: .08em;
    margin-bottom: 8px;
  }
  .invite-code-value {
    font-family: 'Syne', sans-serif;
    font-size: 28px;
    font-weight: 800;
    letter-spacing: .15em;
    color: var(--accent2);
    text-align: center;
    padding: 8px 0;
  }
  .invite-code-expiry {
    font-size: 11px;
    color: var(--text3);
    text-align: center;
    margin-top: 4px;
  }
  .invite-copy-btn {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid var(--accent);
    background: rgba(124,106,247,0.1);
    color: var(--accent2);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 8px;
    transition: all .15s;
  }
  .invite-copy-btn:active { background: rgba(124,106,247,0.2); }
  .member-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }
  .member-item:last-child { border-bottom: none; }
  .member-avatar {
    width: 34px; height: 34px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), #a78bfa);
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
    font-weight: 700;
    color: white;
    flex-shrink: 0;
  }
  .member-info { flex: 1; min-width: 0; }
  .member-email { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .member-role { font-size: 11px; color: var(--text2); }
  .section-label {
    font-size: 11px;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: .08em;
    margin: 16px 0 8px;
  }
  .join-input-wrap {
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }
  .join-input {
    flex: 1;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    letter-spacing: .1em;
    text-transform: uppercase;
    outline: none;
    text-align: center;
  }
  .join-input:focus { border-color: var(--accent); }
  .join-btn {
    padding: 12px 18px;
    border-radius: 12px;
    border: none;
    background: var(--accent);
    color: white;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
  }
  .join-error { font-size: 12px; color: var(--red); margin-top: 6px; min-height: 16px; }
  /* bot√£o de membros no user-bar */
  .members-btn {
    padding: 6px 12px;
    border-radius: 8px;
    border: 1px solid rgba(167,139,250,0.4);
    background: rgba(124,106,247,0.1);
    color: var(--accent2);
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 5px;
    position: relative;
    z-index: 10;
  }


  .auth-choice-wrap {
    display: flex;
    gap: 8px;
    width: 100%;
    max-width: 380px;
  }
  .auth-choice-btn {
    flex: 1;
    padding: 11px 8px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text2);
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all .2s;
    text-align: center;
    line-height: 1.3;
  }
  .auth-choice-btn.selected {
    border-color: var(--accent);
    background: rgba(124,106,247,0.12);
    color: var(--accent2);
  }

  @media (prefers-color-scheme: light) { /* still dark */ }
</style>
</head>
<body>
<!-- Auth Screen -->
<div id="auth-screen">
  <img src="/estoque-manager/icon-192.png" class="auth-logo" alt="Despensa">
  <div class="auth-title">Minha <span>Despensa</span></div>
  <div class="auth-sub">Acesse sua conta para sincronizar em todos os dispositivos</div>
  <div class="auth-tabs">
    <button class="auth-tab active" onclick="switchAuthTab('login')">Entrar</button>
    <button class="auth-tab" onclick="switchAuthTab('register')">Criar conta</button>
  </div>
  <div class="auth-form">
    <input class="auth-input" id="auth-email" type="email" placeholder="Email" autocomplete="email">
    <input class="auth-input" id="auth-username" type="text" placeholder="Nome de usu√°rio" autocomplete="off" style="display:none">
    <input class="auth-input" id="auth-password" type="password" placeholder="Senha" autocomplete="current-password">
    <input class="auth-input" id="auth-password2" type="password" placeholder="Confirmar senha" autocomplete="off" style="display:none">

    <!-- Escolha criar ou entrar (s√≥ no cadastro) -->
    <div id="auth-stock-choice" style="display:none;width:100%;max-width:380px">
      <div class="auth-choice-wrap">
        <button class="auth-choice-btn" id="choice-create" onclick="selectStockChoice('create')">
          üè† Criar Estoque<br><span style="font-size:10px;opacity:.7">Novo estoque pessoal</span>
        </button>
        <button class="auth-choice-btn" id="choice-join" onclick="selectStockChoice('join')">
          üîó Entrar em Estoque<br><span style="font-size:10px;opacity:.7">Usar c√≥digo de convite</span>
        </button>
      </div>
      <input class="auth-input" id="auth-stock-name" type="text" placeholder="Nome do estoque (ex: Fam√≠lia Silva)" autocomplete="off" style="display:none;margin-top:8px">
      <input class="auth-input" id="auth-invite-code" type="text" placeholder="C√≥digo de convite (6 letras)" autocomplete="off" style="display:none;margin-top:8px;text-transform:uppercase;letter-spacing:.1em;text-align:center" oninput="this.value=this.value.toUpperCase()">
    </div>

    <div class="auth-error" id="auth-error"></div>
    <button class="auth-btn" id="auth-submit-btn" onclick="authSubmit()">Entrar</button>
    <div class="auth-divider">ou</div>
    <button class="auth-google-btn" onclick="authGoogle()">
      <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Continuar com Google
    </button>
  </div>
</div>

<!-- Sync indicator -->
<div id="sync-indicator">
  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="animation:spin 1s linear infinite"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
  Sincronizando‚Ä¶
</div>

<div id="app">
  <div id="user-bar">
    <span id="user-email-display"></span>
    <button class="members-btn" onclick="openMembersModal()">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
      Membros
    </button>
    <button class="signout-btn" onclick="doSignOut()">Sair</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="screen active" id="home-screen">
    <div class="header">
      <h1>Minha <span>Despensa</span></h1>
      <p id="home-date"></p>
    </div>
    <div class="scroll-content">
      <div class="home-stats">
        <div class="stat-card purple">
          <div class="stat-num" id="stat-total">0</div>
          <div class="stat-label">Produtos</div>
        </div>
        <div class="stat-card green">
          <div class="stat-num" id="stat-ok">0</div>
          <div class="stat-label">Em estoque</div>
        </div>
        <div class="stat-card yellow">
          <div class="stat-num" id="stat-low">0</div>
          <div class="stat-label">Acabando</div>
        </div>
        <div class="stat-card red">
          <div class="stat-num" id="stat-empty">0</div>
          <div class="stat-label">Zerados</div>
        </div>
      </div>

      <div class="section-title" id="alerts-title" style="display:none">‚ö† Aten√ß√£o</div>
      <div class="alert-list" id="alerts-list"></div>

      <div class="section-title">üì¶ Recentes</div>
      <div class="product-list" id="recent-list">
        <div class="empty"><div class="empty-icon">üõí</div><h3>Estoque vazio</h3><p>Escaneie um produto para come√ßar</p></div>
      </div>
      <button class="see-all-btn" id="see-history-btn" onclick="showScreen('history')" style="display:none">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        Ver hist√≥rico completo
      </button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ESTOQUE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="screen" id="stock-screen">
    <div class="header">
      <h1>Estoque</h1>
      <p>Ajuste da quantidade e edi√ß√£o dos produtos</p>
    </div>
    <div class="search-wrap" style="padding:0 20px 12px;position:relative;">
      <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input class="search-input" id="search-input" type="search" placeholder="Buscar produto‚Ä¶" oninput="filterProducts()">
    </div>
    <div class="cat-tabs" id="cat-tabs">
      <button class="cat-tab active" onclick="filterCat('Todos',this)">Todos</button>
    </div>
    <div class="scroll-content" style="padding-bottom:90px">
      <div class="product-list" id="stock-list"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCANNER (placeholder vazio ‚Äî o overlay real fica fora do #app) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EM USO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="screen" id="inuse-screen">
    <div class="header">
      <h1>Em <span style="color:var(--accent2)">Uso</span></h1>
      <p>Produtos em utiliza√ß√£o no momento</p>
    </div>
    <div class="scroll-content">
      <div id="inuse-add-wrap" style="padding:0 20px 4px">
        <div style="position:relative;">
          <svg style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text3)" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input class="search-input" id="inuse-search" type="search" placeholder="Buscar produto para adicionar‚Ä¶" oninput="renderInuseSearch()" autocomplete="off">
        </div>
        <div id="inuse-search-results" style="display:none;background:var(--card2);border:1px solid var(--border);border-radius:12px;margin-top:6px;overflow:hidden;"></div>
      </div>
      <div class="section-title" style="padding-top:8px">Em uso agora</div>
      <div class="product-list" id="inuse-list" style="padding:0 20px;gap:8px"></div>
      <button class="clear-all-btn" id="inuse-clear-btn" onclick="clearAllInuse()" style="display:none;margin-top:12px">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>
        Limpar todos
      </button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HIST√ìRICO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="screen" id="history-screen">
    <div class="header">
      <div style="display:flex;align-items:center;gap:12px">
        <button class="back-btn" onclick="showScreen('home')" style="background:var(--card);border-color:var(--border);color:var(--text2)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
        </button>
        <div>
          <h1>Hist√≥rico</h1>
          <p>Movimenta√ß√µes recentes</p>
        </div>
      </div>
    </div>
    <div class="scroll-content">
      <div class="hist-list" id="hist-list">
        <div class="empty"><div class="empty-icon">üìã</div><h3>Sem movimentos</h3><p>O hist√≥rico aparece aqui</p></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LISTA DE COMPRAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="screen" id="shopping-screen">
    <div class="header">
      <h1>Lista de <span style="color:var(--accent2)">Compras</span></h1>
      <p>Itens zerados ou quase acabando</p>
    </div>
    <div class="scroll-content">
      <button class="wa-btn" onclick="shareWhatsapp()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="#25d366"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
        Compartilhar no WhatsApp
      </button>
      <div class="section-title" style="padding-top:16px">Itens para comprar</div>
      <div class="product-list" id="shopping-list" style="padding:0 20px;gap:8px"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOTTOM NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <nav id="bottom-nav">
    <button class="nav-btn active" id="nav-home" onclick="showScreen('home')">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <span>In√≠cio</span>
    </button>
    <button class="nav-btn" id="nav-stock" onclick="showScreen('stock')">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
      <span>Estoque</span>
    </button>
    <button class="nav-btn scan-btn" onclick="openScanner()" style="touch-action:manipulation;-webkit-tap-highlight-color:transparent;">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7V5a2 2 0 012-2h2M17 3h2a2 2 0 012 2v2M21 17v2a2 2 0 01-2 2h-2M7 21H5a2 2 0 01-2-2v-2"/><line x1="7" y1="12" x2="7" y2="12.01"/><rect x="10" y="10" width="8" height="4" rx="1"/></svg>
    </button>
    <button class="nav-btn" id="nav-inuse" onclick="showScreen('inuse')">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 2a10 10 0 100 20A10 10 0 0012 2z"/><path d="M12 6v6l4 2"/></svg>
      <span>Em Uso</span>
    </button>
    <button class="nav-btn" id="nav-shopping" onclick="showScreen('shopping')">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 001.99-1.61L23 6H6"/></svg>
      <span>Compras</span>
    </button>
  </nav>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- Product action modal -->
<div class="modal-overlay" id="product-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div>
        <div class="modal-title" id="pm-name">Produto</div>
        <div class="modal-sub" id="pm-sub">Categoria</div>
      </div>
      <button class="modal-close" onclick="closeProductModal()">√ó</button>
    </div>
    <div class="modal-qty-display">
      <div class="modal-qty-num" id="pm-qty">0</div>
      <div class="modal-qty-label">em estoque</div>
    </div>
    <div id="pm-edit-controls">
      <div class="quick-btns">
        <button class="quick-btn add" onclick="quickAdd(1)">+1</button>
        <button class="quick-btn add" onclick="quickAdd(3)">+3</button>
        <button class="quick-btn add" onclick="quickAdd(5)">+5</button>
      </div>
      <div class="quick-btns" style="padding-top:8px">
        <button class="quick-btn remove" onclick="quickRemove(1)">&#8722;1</button>
        <button class="quick-btn add-custom" onclick="showCustomQty()">Personalizado</button>
      </div>
    </div>
    <div id="pm-readonly-hint" style="display:none;padding:14px 20px 0;text-align:center;color:var(--text3);font-size:13px;">
      V&#225; para <strong style="color:var(--accent2)">Estoque</strong> para editar quantidades
    </div>
    <div class="divider"></div>
    <div id="pm-extra-fields">
      <div class="input-row">
        <div class="input-label">Categoria</div>
        <select class="text-input" id="pm-cat" onchange="saveCatOnly()">
          <option value="Geladeira">ü•∂ Geladeira</option>
          <option value="Despensa">üè† Despensa</option>
          <option value="Congelador">üßä Congelador</option>
          <option value="Bebidas">ü•§ Bebidas</option>
          <option value="Hortifruti">ü•¶ Hortifruti</option>
          <option value="Limpeza">üßπ Limpeza</option>
          <option value="Higiene">ü™• Higiene</option>
          <option value="Outros">üì¶ Outros</option>
        </select>
      </div>
      <div class="input-row">
        <div class="input-label">Alerta de estoque baixo</div>
        <input type="number" class="text-input" id="pm-alert-val" min="0" placeholder="Ex: 2" onchange="saveAlertOnly()">
      </div>
    </div>
    <div class="input-row" id="expiry-row">
      <div class="input-label">Validade</div>
      <input type="date" class="text-input" id="pm-expiry" onchange="saveExpiryOnly()">
    </div>
    <button class="action-btn primary" onclick="closeProductModal()" style="margin-top:16px">Fechar</button>
    <button class="action-btn danger" id="pm-delete-btn" onclick="deleteProduct()">Remover produto</button>
    <div style="height:8px"></div>
  </div>
</div>

<!-- New product modal -->
<div class="modal-overlay" id="new-product-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div>
        <div class="modal-title">Novo Produto</div>
        <div class="modal-sub" id="npm-code">C√≥digo detectado</div>
      </div>
      <button class="modal-close" onclick="closeModal('new-product-modal')">√ó</button>
    </div>
    <div class="input-row">
      <div class="input-label">Nome do produto</div>
      <input type="text" class="text-input" id="npm-name" placeholder="Ex: Ketchup Heinz 397g" autocomplete="off">
    </div>
    <div class="input-row">
      <div class="input-label">Categoria</div>
      <select class="text-input" id="npm-cat">
        <option value="Geladeira">ü•∂ Geladeira</option>
        <option value="Despensa" selected>üè† Despensa</option>
        <option value="Congelador">üßä Congelador</option>
        <option value="Bebidas">ü•§ Bebidas</option>
        <option value="Hortifruti">ü•¶ Hortifruti</option>
        <option value="Limpeza">üßπ Limpeza</option>
        <option value="Higiene">ü™• Higiene</option>
        <option value="Outros">üì¶ Outros</option>
      </select>
    </div>
    <div class="input-row">
      <div class="input-label">Quantidade inicial</div>
      <div class="stepper">
        <div class="stepper-btn" onclick="stepQty(-1)">‚àí</div>
        <div class="stepper-val" id="npm-qty">1</div>
        <div class="stepper-btn" onclick="stepQty(1)">+</div>
      </div>
    </div>
    <div class="input-row">
      <div class="input-label">Alerta de estoque baixo (opcional)</div>
      <input type="number" class="text-input" id="npm-alert" placeholder="Ex: 2" min="0">
    </div>
    <button class="action-btn primary" onclick="saveNewProduct()">Cadastrar produto</button>
    <div style="height:8px"></div>
  </div>
</div>

<!-- Custom qty modal -->
<div class="modal-overlay" id="custom-qty-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div><div class="modal-title">Quantidade</div></div>
      <button class="modal-close" onclick="closeModal('custom-qty-modal')">√ó</button>
    </div>
    <div class="input-row" style="padding-top:20px">
      <div class="input-label">Opera√ß√£o</div>
      <select class="text-input" id="cq-op">
        <option value="add">Adicionar (+)</option>
        <option value="remove">Remover (‚àí)</option>
        <option value="set">Definir quantidade</option>
      </select>
    </div>
    <div class="input-row">
      <div class="input-label">Quantidade</div>
      <input type="number" class="text-input" id="cq-val" min="0" placeholder="0">
    </div>
    <button class="action-btn primary" onclick="applyCustomQty()">Aplicar</button>
    <div style="height:8px"></div>
  </div>
</div>

<!-- Modal: digitar c√≥digo manualmente -->
<div class="modal-overlay" id="manual-code-modal" style="z-index:10000">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div><div class="modal-title">Digitar c√≥digo</div></div>
      <button class="modal-close" onclick="closeModal('manual-code-modal')">√ó</button>
    </div>
    <div class="input-row" style="padding-top:20px">
      <div class="input-label">C√≥digo do produto</div>
      <input type="text" class="text-input" id="manual-code-input"
        placeholder="Ex: 7891000100103"
        inputmode="numeric"
        autocomplete="off"
        onkeydown="if(event.key==='Enter') confirmManualCode()">
    </div>
    <button class="action-btn primary" onclick="confirmManualCode()" style="margin-top:16px">Confirmar</button>
    <div style="height:8px"></div>
  </div>
</div>

<!-- Confirm modal (clearAllInuse) -->
<div class="confirm-modal-overlay" id="confirm-clear-modal">
  <div class="confirm-modal">
    <div class="confirm-modal-icon">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
    </div>
    <div class="confirm-modal-title">Limpar lista</div>
    <div class="confirm-modal-desc">Todos os itens em uso ser√£o removidos da lista. Esta a√ß√£o n√£o pode ser desfeita.</div>
    <div class="confirm-modal-btns">
      <button class="btn-cancel" onclick="closeConfirmClear()">Cancelar</button>
      <button class="btn-confirm" onclick="confirmClearAll()">Limpar tudo</button>
    </div>
  </div>
</div>

<!-- Members modal -->
<div class="members-modal-overlay" id="members-modal">
  <div class="members-modal">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
      <div class="members-modal-title">üë• Membros</div>
      <button onclick="closeMembersModal()" style="background:none;border:none;color:var(--text2);font-size:22px;cursor:pointer;padding:0">√ó</button>
    </div>
    <div class="members-modal-sub" id="members-despensa-name">Sua despensa</div>

    <!-- C√≥digo de convite (vis√≠vel para o dono) -->
    <div id="invite-code-section">
      <div class="section-label">C√≥digo de convite</div>
      <div class="invite-code-box">
        <div class="invite-code-label">Compartilhe este c√≥digo</div>
        <div class="invite-code-value" id="invite-code-display">‚Äî‚Äî</div>
        <div class="invite-code-expiry" id="invite-code-expiry"></div>
        <button class="invite-copy-btn" onclick="copyInviteCode()">üìã Copiar c√≥digo</button>
      </div>
      <button class="action-btn primary" onclick="generateInviteCode()" style="width:100%;margin-bottom:16px">
        üîÑ Gerar novo c√≥digo
      </button>
    </div>

    <!-- Entrar com c√≥digo (para n√£o-donos / nova conta) -->
    <div id="join-code-section" style="display:none">
      <div class="section-label">Entrar em uma despensa</div>
      <div class="join-input-wrap">
        <input class="join-input" id="join-code-input" type="text" maxlength="6" placeholder="C√ìDIGO" autocomplete="off" oninput="this.value=this.value.toUpperCase()">
        <button class="join-btn" onclick="joinWithCode()">Entrar</button>
      </div>
      <div class="join-error" id="join-error"></div>
    </div>

    <!-- Lista de membros -->
    <div class="section-label" style="margin-top:20px">Membros da despensa</div>
    <div id="members-list"></div>

    <div style="height:8px"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STORAGE ‚Äî Firebase + cache local
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DB = {
  products: [],
  stock: {},
  history: [],
  inuse: [],
  _uid: null,
  _unsubscribe: null,

  // Salva no Firestore (debounced para evitar writes excessivos)
  _saveTimer: null,
  save() {
    // Salva local imediatamente para UI responsiva
    localStorage.setItem('dp_products', JSON.stringify(this.products));
    localStorage.setItem('dp_stock', JSON.stringify(this.stock));
    localStorage.setItem('dp_history', JSON.stringify(this.history));
    localStorage.setItem('dp_inuse', JSON.stringify(this.inuse));
    // Sincroniza com Firestore
    if (this._despensaId) {
      clearTimeout(this._saveTimer);
      this._saveTimer = setTimeout(() => this._syncToFirestore(), 800);
    }
  },

  async _syncToFirestore() {
    if (!this._uid || !window._FB) return;
    showSyncIndicator();
    try {
      const { db, doc, setDoc } = window._FB;
      await setDoc(doc(db, 'despensas', this._uid), {
        products: this.products,
        stock: this.stock,
        history: this.history.slice(0, 200), // limita hist√≥rico
        inuse: this.inuse,
        updatedAt: new Date().toISOString(),
        members: [this._uid]
      });
    } catch(e) {
      console.warn('Sync error:', e);
    } finally {
      hideSyncIndicator();
    }
  },

  _despensaId: null, // pode ser diferente do uid se for membro convidado

  async _syncToFirestore() {
    if (!this._despensaId || !window._FB) return;
    showSyncIndicator();
    try {
      const { db, doc, setDoc } = window._FB;
      await setDoc(doc(db, 'despensas', this._despensaId), {
        products: this.products,
        stock: this.stock,
        history: this.history.slice(0, 200),
        inuse: this.inuse,
        updatedAt: new Date().toISOString(),
      }, { merge: true });
    } catch(e) {
      console.warn('Sync error:', e);
    } finally {
      hideSyncIndicator();
    }
  },

  // Descobre a qual despensa o usu√°rio pertence e inicia sync
  async startSync(uid) {
    this._uid = uid;
    if (this._unsubscribe) this._unsubscribe();
    if (!window._FB) return;
    const { db, doc, getDoc, setDoc, onSnapshot } = window._FB;

    // Verifica se usu√°rio tem um perfil com despensaId
    const userRef = doc(db, 'users', uid);
    const userSnap = await getDoc(userRef);
    let despensaId;

    if (userSnap.exists() && userSnap.data().despensaId) {
      despensaId = userSnap.data().despensaId;
    } else {
      // Primeiro acesso ‚Äî cria despensa pr√≥pria
      despensaId = uid;
      await setDoc(userRef, {
        despensaId: uid,
        email: window._FB.auth.currentUser?.email || '',
        joinedAt: new Date().toISOString()
      });
    }

    this._despensaId = despensaId;
    localStorage.setItem('dp_despensaId', despensaId);

    // Exibe username na user-bar
    const username = userSnap.exists() ? (userSnap.data().username || userSnap.data().email || '') : '';
    const displayEl = document.getElementById('user-email-display');
    if (displayEl) displayEl.textContent = username;

    // Escuta mudan√ßas em tempo real na despensa
    this._unsubscribe = onSnapshot(doc(db, 'despensas', despensaId), (snap) => {
      if (snap.exists()) {
        const data = snap.data();
        this.products = data.products || [];
        this.stock = data.stock || {};
        this.history = data.history || [];
        this.inuse = data.inuse || [];
        localStorage.setItem('dp_products', JSON.stringify(this.products));
        localStorage.setItem('dp_stock', JSON.stringify(this.stock));
        localStorage.setItem('dp_history', JSON.stringify(this.history));
        localStorage.setItem('dp_inuse', JSON.stringify(this.inuse));
      } else {
        // Cria documento inicial, migrando dados locais se existirem
        const localProducts = JSON.parse(localStorage.getItem('dp_products') || '[]');
        this.products = localProducts;
        this.stock = JSON.parse(localStorage.getItem('dp_stock') || '{}');
        this.history = JSON.parse(localStorage.getItem('dp_history') || '[]');
        this.inuse = JSON.parse(localStorage.getItem('dp_inuse') || '[]');
        this._syncToFirestore();
      }
      refreshCurrentScreen();
      renderCatTabs();
    });
  },

  stopSync() {
    if (this._unsubscribe) { this._unsubscribe(); this._unsubscribe = null; }
    this._uid = null;
    this._despensaId = null;
  }
};

// Carrega cache local enquanto aguarda Firebase
DB.products = JSON.parse(localStorage.getItem('dp_products') || '[]');
DB.stock = JSON.parse(localStorage.getItem('dp_stock') || '{}');
DB.history = JSON.parse(localStorage.getItem('dp_history') || '[]');
DB.inuse = JSON.parse(localStorage.getItem('dp_inuse') || '[]');

// Sync indicator
let _syncTimer;
function showSyncIndicator() {
  const el = document.getElementById('sync-indicator');
  if (el) el.classList.add('show');
}
function hideSyncIndicator() {
  const el = document.getElementById('sync-indicator');
  if (el) setTimeout(() => el.classList.remove('show'), 600);
}

const EMOJIS = {
  Geladeira:'ü•õ', Despensa:'üè†', Congelador:'üßä', Bebidas:'ü•§',
  Hortifruti:'ü•¶', Limpeza:'üßπ', Higiene:'ü™•', Outros:'üì¶'
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentScreen = 'home';

function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(name + '-screen').classList.add('active');
  const nb = document.getElementById('nav-' + name);
  if (nb) nb.classList.add('active');
  currentScreen = name;
  if (name === 'home') renderHome();
  if (name === 'stock') renderStock();
  if (name === 'history') renderHistory();
  if (name === 'shopping') renderShopping();
  if (name === 'inuse') renderInuse();
}

// Atualiza a tela atual sem navegar ‚Äî FIX #5
function refreshCurrentScreen() {
  if (currentScreen === 'home') renderHome();
  else if (currentScreen === 'stock') renderStock();
  else if (currentScreen === 'history') renderHistory();
  else if (currentScreen === 'shopping') renderShopping();
  else if (currentScreen === 'inuse') renderInuse();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCANNER ‚Äî BarcodeDetector (Android/Chrome) + ZXing API alto n√≠vel (iOS/Safari)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _stream = null;
let _lastCode = null;
let _screenBeforeScanner = 'home';
let _nativeDetector = null;
let _zxingHLReader = null; // BrowserMultiFormatReader ‚Äî API de alto n√≠vel, funciona no iOS
let _scanActive = false;
let _scanRafId = null;

// Pr√©-inicializa detectores assim que ZXing carrega
function initDetectors() {
  if ('BarcodeDetector' in window) {
    try {
      _nativeDetector = new BarcodeDetector({
        formats: ['ean_13','ean_8','upc_a','upc_e','code_128','code_39','qr_code','data_matrix','itf','codabar']
      });
    } catch(e) { _nativeDetector = null; }
  }
  if (window.ZXing) {
    try {
      _zxingHLReader = new ZXing.BrowserMultiFormatReader();
    } catch(e) { _zxingHLReader = null; }
  }
}

// ZXing pode demorar a carregar ‚Äî tenta agora e tamb√©m quando o script terminar
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initDetectors);
} else {
  initDetectors();
}

async function openScanner() {
  _screenBeforeScanner = currentScreen;
  _lastCode = null;
  _scanActive = true;
  // Mostra o overlay isolado ‚Äî n√£o toca no sistema de .screen
  document.getElementById('scanner-overlay').style.display = 'block';

  // Garante que detectores est√£o prontos
  if (!_nativeDetector && !_zxingHLReader) initDetectors();

  const vid = document.getElementById('scanner-video');

  try {
    _stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: 'environment' },
        width:  { ideal: 1280 },
        height: { ideal: 720 }
      }
    });
    vid.srcObject = _stream;
    await vid.play();

    if (_nativeDetector) {
      // Android/Chrome: BarcodeDetector nativo ‚Äî r√°pido e preciso
      startNativeScan(vid);
    } else if (_zxingHLReader) {
      // iOS/Safari: ZXing API de alto n√≠vel ‚Äî usa decodeFromStream internamente
      startZXingHighLevel();
    } else {
      showToast('Scanner n√£o dispon√≠vel. Use o c√≥digo manual.');
    }
  } catch(e) {
    showToast('Permita o acesso √† c√¢mera e tente novamente.');
    stopScan();
    showScreen(_screenBeforeScanner);
  }
}

// ‚îÄ‚îÄ Android/Chrome: BarcodeDetector nativo ‚îÄ‚îÄ
function startNativeScan(vid) {
  const loop = async () => {
    if (!_scanActive) return;
    try {
      if (vid.readyState === vid.HAVE_ENOUGH_DATA) {
        const results = await _nativeDetector.detect(vid);
        if (results.length > 0) {
          const code = results[0].rawValue;
          if (code && code !== _lastCode) {
            _lastCode = code;
            stopScan();
            handleCode(code);
            return;
          }
        }
      }
    } catch(e) {}
    _scanRafId = requestAnimationFrame(loop);
  };
  _scanRafId = requestAnimationFrame(loop);
}

// ‚îÄ‚îÄ iOS/Safari: ZXing BrowserMultiFormatReader (API de alto n√≠vel) ‚îÄ‚îÄ
// Este m√©todo usa decodeFromStream que √© otimizado pelo pr√≥prio ZXing para v√≠deo
function startZXingHighLevel() {
  const vid = document.getElementById('scanner-video');
  if (!_stream) return;

  _zxingHLReader.decodeFromStream(_stream, vid, (result, err) => {
    if (!_scanActive) return;
    if (result) {
      const code = result.getText();
      if (code && code !== _lastCode) {
        _lastCode = code;
        stopScan();
        handleCode(code);
      }
    }
    // err do tipo NotFoundException √© normal quando n√£o h√° c√≥digo no frame ‚Äî ignorar
  });
}

function stopScan() {
  _scanActive = false;
  if (_scanRafId) { cancelAnimationFrame(_scanRafId); _scanRafId = null; }
  if (_zxingHLReader) {
    try { _zxingHLReader.reset(); } catch(e) {}
  }
  if (_stream) {
    _stream.getTracks().forEach(t => t.stop());
    _stream = null;
  }
  const vid = document.getElementById('scanner-video');
  if (vid) vid.srcObject = null;
}

function closeScanner() {
  stopScan();
  // Esconde o overlay ‚Äî a tela anterior continua intacta por baixo
  document.getElementById('scanner-overlay').style.display = 'none';
  // Garante que a tela de origem est√° ativa (pode ter sido limpada)
  showScreen(_screenBeforeScanner);
}

function manualCode() {
  document.getElementById('manual-code-input').value = '';
  openModal('manual-code-modal');
  setTimeout(() => document.getElementById('manual-code-input').focus(), 350);
}

function confirmManualCode() {
  const code = document.getElementById('manual-code-input').value.trim();
  if (!code) { showToast('Digite um c√≥digo'); return; }
  closeModal('manual-code-modal');
  stopScan();
  handleCode(code);
}

function handleCode(code) {
  // Garante que o overlay do scanner est√° fechado antes de qualquer a√ß√£o
  document.getElementById('scanner-overlay').style.display = 'none';
  const product = DB.products.find(p => p.code === code);
  if (product) {
    showScreen('home');
    openProductModal(product);
  } else {
    // Produto desconhecido: vai para in√≠cio, abre modal de cadastro ‚Äî FIX #4
    _newQty = 1; // FIX #1: reseta qty antes de abrir modal
    document.getElementById('npm-code').textContent = code;
    document.getElementById('npm-name').value = '';
    document.getElementById('npm-qty').textContent = '1';
    document.getElementById('npm-alert').value = '';
    document.getElementById('npm-cat').value = 'Despensa';
    window._pendingCode = code;
    showScreen('home');
    openModal('new-product-modal');
    setTimeout(() => document.getElementById('npm-name').focus(), 350);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PRODUCT MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _activeProduct = null;

// Debounce para consolidar cliques r√°pidos no hist√≥rico ‚Äî FIX #7
let _pendingHistEntry = null;   // {pid, type, delta, timer}

function flushHistory() {
  if (!_pendingHistEntry) return;
  clearTimeout(_pendingHistEntry.timer);
  if (_pendingHistEntry.delta !== 0) {
    DB.history.unshift({
      pid: _pendingHistEntry.pid,
      type: _pendingHistEntry.type,
      qty: Math.abs(_pendingHistEntry.delta),
      date: new Date().toISOString()
    });
    DB.save();
  }
  _pendingHistEntry = null;
}

function scheduleHistory(pid, type, delta) {
  // Se j√° tem pendente para o mesmo produto e tipo, acumula
  if (_pendingHistEntry && _pendingHistEntry.pid === pid && _pendingHistEntry.type === type) {
    clearTimeout(_pendingHistEntry.timer);
    _pendingHistEntry.delta += delta;
  } else {
    // Outro produto/tipo: salva o anterior imediatamente
    flushHistory();
    _pendingHistEntry = { pid, type, delta };
  }
  // Aguarda 1.5s sem cliques para registrar
  _pendingHistEntry.timer = setTimeout(flushHistory, 1500);
}

function handleAlertClick(el) {
  const id = el.dataset.pid;
  const product = DB.products.find(p => p.id === id);
  if (product) openProductModal(product);
}

function handleProductClick(el) {
  const id = el.dataset.pid;
  const product = DB.products.find(p => p.id === id);
  if (!product) return;
  if (currentScreen === 'home') {
    openProductModalReadOnly(product);
  } else {
    openProductModal(product);
  }
}

function openProductModalReadOnly(product) {
  // Modal de visualiza√ß√£o ‚Äî sem bot√µes de +/- nem remover
  flushHistory();
  _activeProduct = product;
  const qty = DB.stock[product.id] ?? 0;
  document.getElementById('pm-name').textContent = product.name;
  document.getElementById('pm-sub').textContent = `${EMOJIS[product.cat] || 'üì¶'} ${product.cat}  ‚Ä¢  C√≥digo: ${product.code}`;
  document.getElementById('pm-qty').textContent = qty;
  document.getElementById('pm-qty').className = 'modal-qty-num ' + qtyClass(qty, product.alert);
  document.getElementById('pm-expiry').value = product.expiry || '';
  document.getElementById('expiry-row').style.display = qty === 0 ? 'none' : '';
  document.getElementById('pm-cat').value = product.cat || 'Despensa';
  document.getElementById('pm-alert-val').value = product.alert || '';
  // Esconde controles de edi√ß√£o
  document.getElementById('pm-edit-controls').style.display = 'none';
  document.getElementById('pm-extra-fields').style.display = 'none';
  document.getElementById('pm-delete-btn').style.display = 'none';
  document.getElementById('pm-readonly-hint').style.display = '';
  openModal('product-modal');
}

function openProductModal(product) {
  // Garante que flushamos hist√≥rico pendente de qualquer produto anterior ‚Äî FIX #7/#8
  flushHistory();
  _activeProduct = product;
  const qty = DB.stock[product.id] ?? 0;
  document.getElementById('pm-name').textContent = product.name;
  document.getElementById('pm-sub').textContent = `${EMOJIS[product.cat] || 'üì¶'} ${product.cat}  ‚Ä¢  C√≥digo: ${product.code}`;
  document.getElementById('pm-qty').textContent = qty;
  document.getElementById('pm-qty').className = 'modal-qty-num ' + qtyClass(qty, product.alert);
  document.getElementById('pm-expiry').value = product.expiry || '';
  document.getElementById('expiry-row').style.display = qty === 0 ? 'none' : '';
  document.getElementById('pm-cat').value = product.cat || 'Despensa';
  document.getElementById('pm-alert-val').value = product.alert || '';
  // Garante que controles de edi√ß√£o est√£o vis√≠veis
  document.getElementById('pm-edit-controls').style.display = '';
  document.getElementById('pm-extra-fields').style.display = '';
  document.getElementById('pm-delete-btn').style.display = '';
  document.getElementById('pm-readonly-hint').style.display = 'none';
  openModal('product-modal');
}

function updateModalQty(newQty) {
  document.getElementById('pm-qty').textContent = newQty;
  document.getElementById('pm-qty').className = 'modal-qty-num ' + qtyClass(newQty, _activeProduct.alert);
  // Esconde validade se zerou ‚Äî FIX #2
  document.getElementById('expiry-row').style.display = newQty === 0 ? 'none' : '';
  if (newQty === 0) {
    // Limpa a validade ao zerar ‚Äî FIX #2
    _activeProduct.expiry = '';
    document.getElementById('pm-expiry').value = '';
    const idx = DB.products.findIndex(p => p.id === _activeProduct.id);
    if (idx >= 0) DB.products[idx].expiry = '';
  }
}

function quickAdd(n) {
  if (!_activeProduct) return;
  DB.stock[_activeProduct.id] = (DB.stock[_activeProduct.id] || 0) + n;
  const qty = DB.stock[_activeProduct.id];
  DB.save(); // FIX #8: salva imediatamente
  updateModalQty(qty);
  scheduleHistory(_activeProduct.id, 'entry', n); // FIX #7: acumula no hist√≥rico
  refreshCurrentScreen(); // FIX #5: atualiza tela de fundo
  showToast(`+${n} ¬∑ ${_activeProduct.name} (${qty})`);
}

function quickRemove(n) {
  if (!_activeProduct) return;
  const curr = DB.stock[_activeProduct.id] || 0;
  const newQty = Math.max(0, curr - n);
  const removed = curr - newQty;
  DB.stock[_activeProduct.id] = newQty;
  DB.save(); // FIX #8: salva imediatamente
  updateModalQty(newQty);
  if (removed > 0) scheduleHistory(_activeProduct.id, 'exit', removed); // FIX #7
  refreshCurrentScreen(); // FIX #5
  showToast(`‚àí${removed} ¬∑ ${_activeProduct.name} (${newQty})`);
}

function showCustomQty() {
  document.getElementById('cq-val').value = '';
  openModal('custom-qty-modal');
}

function applyCustomQty() {
  if (!_activeProduct) return;
  const op = document.getElementById('cq-op').value;
  const val = parseInt(document.getElementById('cq-val').value) || 0;
  const curr = DB.stock[_activeProduct.id] || 0;
  let newQty, histQty, histType;
  if (op === 'add') { newQty = curr + val; histQty = val; histType = 'entry'; }
  else if (op === 'remove') { newQty = Math.max(0, curr - val); histQty = curr - newQty; histType = 'exit'; }
  else { newQty = Math.max(0, val); histQty = Math.abs(newQty - curr); histType = newQty >= curr ? 'entry' : 'exit'; }
  flushHistory(); // FIX #7: garante que pendente anterior foi salvo
  DB.stock[_activeProduct.id] = newQty;
  if (histQty > 0) DB.history.unshift({pid: _activeProduct.id, type:histType, qty:histQty, date: new Date().toISOString()});
  DB.save(); // FIX #8
  closeModal('custom-qty-modal');
  updateModalQty(newQty);
  refreshCurrentScreen(); // FIX #5
  showToast(`Estoque atualizado: ${newQty}`);
}

function saveCatOnly() {
  if (!_activeProduct) return;
  const newCat = document.getElementById('pm-cat').value;
  _activeProduct.cat = newCat;
  const idx = DB.products.findIndex(p => p.id === _activeProduct.id);
  if (idx >= 0) DB.products[idx].cat = newCat;
  DB.save();
  refreshCurrentScreen();
  showToast('Categoria atualizada!');
}

function saveAlertOnly() {
  if (!_activeProduct) return;
  const val = parseInt(document.getElementById('pm-alert-val').value) || 0;
  _activeProduct.alert = val;
  const idx = DB.products.findIndex(p => p.id === _activeProduct.id);
  if (idx >= 0) DB.products[idx].alert = val;
  DB.save();
  refreshCurrentScreen();
  showToast('Alerta atualizado!');
}

function saveExpiryOnly() {
  if (!_activeProduct) return;
  _activeProduct.expiry = document.getElementById('pm-expiry').value;
  const idx = DB.products.findIndex(p => p.id === _activeProduct.id);
  if (idx >= 0) DB.products[idx].expiry = _activeProduct.expiry;
  DB.save();
  refreshCurrentScreen();
  showToast('Validade salva!');
}

function closeProductModal() {
  if (!_activeProduct) return;
  flushHistory();
  _activeProduct.expiry = document.getElementById('pm-expiry').value;
  const idx = DB.products.findIndex(p => p.id === _activeProduct.id);
  if (idx >= 0) DB.products[idx].expiry = _activeProduct.expiry;
  DB.save();
  closeModal('product-modal');
  refreshCurrentScreen();
}

function deleteProduct() {
  if (!_activeProduct || !confirm(`Remover "${_activeProduct.name}"?`)) return;
  flushHistory();
  // Grava o nome em todos os registros de hist√≥rico deste produto antes de deletar
  const nameSnapshot = _activeProduct.name;
  DB.history = DB.history.map(h =>
    h.pid === _activeProduct.id ? { ...h, deletedName: nameSnapshot } : h
  );
  DB.products = DB.products.filter(p => p.id !== _activeProduct.id);
  delete DB.stock[_activeProduct.id];
  DB.save();
  closeModal('product-modal');
  refreshCurrentScreen();
  showToast('Produto removido');
}

// Fechar clicando fora do modal
document.getElementById('product-modal').addEventListener('click', function(e) {
  if (e.target === this) closeProductModal();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NEW PRODUCT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _newQty = 1; // FIX #1: vari√°vel isolada, resetada em handleCode

function stepQty(delta) {
  _newQty = Math.max(0, _newQty + delta); // FIX #1: usa _newQty limpo, sem depender de estado anterior
  document.getElementById('npm-qty').textContent = _newQty;
}

function saveNewProduct() {
  const name = document.getElementById('npm-name').value.trim();
  if (!name) { document.getElementById('npm-name').focus(); showToast('Digite o nome do produto'); return; }
  const cat = document.getElementById('npm-cat').value;
  const qty = _newQty; // FIX #1: usa vari√°vel local, n√£o o texto do DOM
  const alertVal = parseInt(document.getElementById('npm-alert').value) || 0;
  const code = window._pendingCode || Date.now().toString();
  const id = 'p' + Date.now();
  DB.products.push({id, code, name, cat, alert: alertVal, expiry:''});
  DB.stock[id] = qty;
  if (qty > 0) DB.history.unshift({pid: id, type:'entry', qty, date: new Date().toISOString()});
  DB.save();
  window._pendingCode = null;
  _newQty = 1; // FIX #1: reset ap√≥s salvar
  closeModal('new-product-modal');
  showToast(`‚úì "${name}" cadastrado!`);
  // Sempre vai para in√≠cio ap√≥s cadastro ‚Äî FIX #4
  showScreen('home');
  renderCatTabs();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function qtyClass(qty, alert=2) {
  if (qty === 0) return 'zero';
  if (qty <= (alert || 2)) return 'low';
  return 'ok';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EM USO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderInuseSearch() {
  const q = document.getElementById('inuse-search').value.trim().toLowerCase();
  const resultsEl = document.getElementById('inuse-search-results');
  if (!q) { resultsEl.style.display = 'none'; resultsEl.innerHTML = ''; return; }
  const matches = DB.products.filter(p =>
    p.name.toLowerCase().includes(q) && (DB.stock[p.id] || 0) > 0
  ).slice(0, 5);
  if (!matches.length) {
    resultsEl.style.display = 'none';
    return;
  }
  resultsEl.style.display = 'block';
  resultsEl.innerHTML = matches.map(p => `
    <div onclick="addToInuse('${p.id}')" style="
      display:flex;align-items:center;gap:12px;padding:12px 14px;
      cursor:pointer;border-bottom:1px solid var(--border);transition:background .15s;
    " onmousedown="event.preventDefault()">
      <span style="font-size:20px">${EMOJIS[p.cat]||'üì¶'}</span>
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.name}</div>
        <div style="font-size:11px;color:var(--text2)">${p.cat} ¬∑ ${DB.stock[p.id]} unid.</div>
      </div>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent2)" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    </div>
  `).join('');
}

function addToInuse(pid) {
  const product = DB.products.find(p => p.id === pid);
  if (!product) return;
  const qty = DB.stock[pid] || 0;
  if (qty <= 0) { showToast('Produto sem estoque!'); return; }
  // Desconta 1 do estoque
  DB.stock[pid] = qty - 1;
  DB.history.unshift({ pid, type: 'exit', qty: 1, date: new Date().toISOString() });
  // Adiciona √† lista em uso (entrada separada por uso)
  DB.inuse.push({ id: 'u' + Date.now(), pid, addedAt: new Date().toISOString() });
  DB.save();
  // Limpa busca
  document.getElementById('inuse-search').value = '';
  document.getElementById('inuse-search-results').style.display = 'none';
  renderInuse();
  refreshCurrentScreen();
  showToast(`${product.name} em uso ¬∑ estoque: ${DB.stock[pid]}`);
}

function removeFromInuse(uid) {
  DB.inuse = DB.inuse.filter(u => u.id !== uid);
  DB.save();
  renderInuse();
}

function clearAllInuse() {
  if (!DB.inuse.length) return;
  document.getElementById('confirm-clear-modal').classList.add('open');
}

function closeConfirmClear() {
  document.getElementById('confirm-clear-modal').classList.remove('open');
}

function confirmClearAll() {
  closeConfirmClear();
  DB.inuse = [];
  DB.save();
  renderInuse();
  showToast('Lista em uso limpa');
}

// Fechar clicando fora
document.getElementById('confirm-clear-modal').addEventListener('click', function(e) {
  if (e.target === this) closeConfirmClear();
});

function renderInuse() {
  const el = document.getElementById('inuse-list');
  const clearBtn = document.getElementById('inuse-clear-btn');
  if (!DB.inuse.length) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">‚è±</div><h3>Nenhum produto em uso</h3><p>Busque um produto acima para adicionar</p></div>`;
    clearBtn.style.display = 'none';
    return;
  }
  clearBtn.style.display = '';
  el.innerHTML = DB.inuse.slice().reverse().map(u => {
    const p = DB.products.find(x => x.id === u.pid);
    const name = p ? p.name : (u.deletedName || 'Produto removido');
    const cat = p ? p.cat : '';
    const emoji = p ? (EMOJIS[p.cat]||'üì¶') : 'üì¶';
    const time = new Date(u.addedAt).toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit' });
    const date = new Date(u.addedAt).toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit' });
    const today = new Date().toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit' });
    const when = date === today ? `hoje √†s ${time}` : `${date} √†s ${time}`;
    return `<div class="inuse-item">
      <div class="product-emoji" style="width:42px;height:42px;font-size:22px;background:var(--card2);border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0">${emoji}</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:14px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${name}</div>
        <div style="font-size:11px;color:var(--text2);margin-top:2px">${cat ? cat + ' ¬∑ ' : ''}${when}</div>
      </div>
      <button class="inuse-delete" onclick="removeFromInuse('${u.id}')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>`;
  }).join('');
}

function renderHome() {
  const today = new Date();
  document.getElementById('home-date').textContent = today.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long'});

  const total = DB.products.length;
  const empty = DB.products.filter(p => (DB.stock[p.id]||0) === 0).length;
  const low = DB.products.filter(p => { const q=DB.stock[p.id]||0; return q>0 && q<=(p.alert||2); }).length;
  const ok = total - empty - low;
  document.getElementById('stat-total').textContent = total;
  document.getElementById('stat-ok').textContent = ok;
  document.getElementById('stat-low').textContent = low;
  document.getElementById('stat-empty').textContent = empty;

  // alerts ‚Äî inclui vencidos, zerados e acabando; ordena: vencido > zerado > acabando
  const now = new Date();
  const isExpired = p => p.expiry && (DB.stock[p.id]||0) > 0 && new Date(p.expiry) < now;
  const isZero   = p => (DB.stock[p.id]||0) === 0;
  const isLow    = p => { const q=DB.stock[p.id]||0; return q>0 && q<=(p.alert||2); };

  const alertPriority = p => {
    if (isExpired(p)) return 0;
    if (isZero(p))    return 1;
    return 2;
  };

  const alerts = DB.products
    .filter(p => isExpired(p) || isZero(p) || isLow(p))
    .sort((a,b) => alertPriority(a) - alertPriority(b));

  const alertsEl = document.getElementById('alerts-list');
  const alertsTitle = document.getElementById('alerts-title');
  if (alerts.length) {
    alertsTitle.style.display = '';
    alertsEl.innerHTML = alerts.map(p => {
      const q = DB.stock[p.id]||0;
      const expired = isExpired(p);
      const zero    = isZero(p);
      let cls = 'alert-item';
      let dotStyle = '';
      let qtyStyle = '';
      let label = '';
      if (expired) {
        cls += ' expired';
        dotStyle = 'background:var(--yellow);box-shadow:0 0 8px var(--yellow)';
        qtyStyle = 'color:var(--yellow)';
        label = 'VENCIDO';
      } else if (zero) {
        cls += ' zero';
        dotStyle = '';
        qtyStyle = '';
        label = 'ZERADO';
      } else {
        qtyStyle = 'color:var(--yellow)';
        dotStyle = 'background:var(--yellow);box-shadow:0 0 8px var(--yellow)';
        label = 's√≥ ' + q;
      }
      return `<div class="${cls}" data-pid="${p.id}" onclick="handleAlertClick(this)">
        <div class="alert-dot" style="${dotStyle}"></div>
        <div class="alert-name">${p.name}</div>
        <div class="alert-qty" style="${qtyStyle}">${label}</div>
      </div>`;
    }).join('');
  } else {
    alertsTitle.style.display = 'none';
    alertsEl.innerHTML = '';
  }

  // recent (last 6 moved)
  const recentEl = document.getElementById('recent-list');
  const recent = [...DB.products].sort((a,b) => {
    const ah = DB.history.findIndex(h => h.pid === a.id);
    const bh = DB.history.findIndex(h => h.pid === b.id);
    return (ah === -1 ? 9999 : ah) - (bh === -1 ? 9999 : bh);
  }).slice(0, 5);

  if (DB.products.length === 0) {
    recentEl.innerHTML = `<div class="empty"><div class="empty-icon">üõí</div><h3>Estoque vazio</h3><p>Escaneie um produto para come√ßar</p></div>`;
    document.getElementById('see-history-btn').style.display = 'none';
  } else {
    recentEl.innerHTML = recent.map(p => productItemHTML(p, false)).join('');
    document.getElementById('see-history-btn').style.display = DB.history.length > 0 ? '' : 'none';
  }
}

function productItemHTML(p, clickable=true) {
  const qty = DB.stock[p.id] || 0;
  const qc = qtyClass(qty, p.alert);
  let expBadge = '';
  // FIX #2: n√£o exibe validade se zerado
  if (p.expiry && qty > 0) {
    const diff = (new Date(p.expiry) - new Date()) / 86400000;
    if (diff < 0) expBadge = `<span class="expiry-badge expiry-expired">Vencido</span>`;
    else if (diff < 7) expBadge = `<span class="expiry-badge expiry-soon">Vence em ${Math.ceil(diff)}d</span>`;
    else expBadge = `<span class="expiry-badge expiry-ok">Val. ${new Date(p.expiry).toLocaleDateString('pt-BR')}</span>`;
  }
  return `<div class="product-item" data-pid="${p.id}" ${clickable ? 'onclick="handleProductClick(this)"' : 'style="cursor:default"'}>
    <div class="product-emoji">${EMOJIS[p.cat]||'üì¶'}</div>
    <div class="product-info">
      <div class="product-name">${p.name}</div>
      <div class="product-cat">${p.cat}${expBadge ? ' ¬∑ '+expBadge : ''}</div>
    </div>
    <div class="product-qty">
      <div class="qty-num ${qc}">${qty}</div>
      <div class="qty-label">unid.</div>
    </div>
  </div>`;
}

// Stock screen
let _filterCat = 'Todos';
let _filterText = '';

function renderCatTabs() {
  const cats = ['Todos', ...new Set(DB.products.map(p=>p.cat))];
  const tabs = document.getElementById('cat-tabs');
  tabs.innerHTML = cats.map(c =>
    `<button class="cat-tab${c===_filterCat?' active':''}" onclick="filterCat('${c}',this)">${c}</button>`
  ).join('');
}

function filterCat(cat, btn) {
  _filterCat = cat;
  document.querySelectorAll('.cat-tab').forEach(b=>b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderStock();
}

function filterProducts() {
  _filterText = document.getElementById('search-input').value.toLowerCase();
  renderStock();
}

function renderStock() {
  renderCatTabs();
  let products = DB.products;
  if (_filterCat !== 'Todos') products = products.filter(p=>p.cat===_filterCat);
  if (_filterText) products = products.filter(p=>p.name.toLowerCase().includes(_filterText));
  products.sort((a,b) => a.name.localeCompare(b.name));
  const el = document.getElementById('stock-list');
  if (products.length === 0) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">üîç</div><h3>Nenhum produto</h3><p>Tente outro filtro ou escaneie algo novo</p></div>`;
  } else {
    el.innerHTML = products.map(p => productItemHTML(p)).join('');
  }
}

function renderHistory() {
  const el = document.getElementById('hist-list');
  if (DB.history.length === 0) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">üìã</div><h3>Sem movimentos</h3><p>O hist√≥rico aparece aqui</p></div>`;
    return;
  }
  el.innerHTML = DB.history.slice(0, 100).map(h => {
    const p = DB.products.find(x=>x.id===h.pid);
    const name = p ? p.name : (h.deletedName ? `${h.deletedName} (removido)` : 'Produto removido');
    const date = new Date(h.date).toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
    const icon = h.type==='entry' ? 'üì•' : 'üì§';
    const sign = h.type==='entry' ? '+' : '‚àí';
    return `<div class="hist-item">
      <div class="hist-icon ${h.type}">${icon}</div>
      <div class="hist-info">
        <div class="hist-name">${name}</div>
        <div class="hist-date">${date}</div>
      </div>
      <div class="hist-qty ${h.type}">${sign}${h.qty}</div>
    </div>`;
  }).join('');
}

// FIX #6: set de marcados; se vazio ‚Üí envia todos
let _shoppingChecked = new Set();

function renderShopping() {
  const items = DB.products.filter(p => (DB.stock[p.id]||0) <= (p.alert||2)).sort((a,b)=>a.cat.localeCompare(b.cat));
  const el = document.getElementById('shopping-list');
  if (items.length === 0) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">‚úÖ</div><h3>Tudo em ordem!</h3><p>Nenhum item para comprar no momento</p></div>`;
    return;
  }
  el.innerHTML = items.map(p => {
    const checked = _shoppingChecked.has(p.id);
    const qty = DB.stock[p.id]||0;
    return `<div class="shopping-item${checked?' checked':''}" onclick="toggleShoppingCheck('${p.id}')">
      <div class="check-circle">${checked?'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>':''}</div>
      <div class="product-emoji" style="width:38px;height:38px;font-size:18px">${EMOJIS[p.cat]||'üì¶'}</div>
      <div class="product-info">
        <div class="product-name">${p.name}</div>
        <div class="product-cat">${p.cat} ¬∑ ${qty===0?'<span style="color:var(--red)">Zerado</span>':'<span style="color:var(--yellow)">S√≥ '+qty+'</span>'}</div>
      </div>
    </div>`;
  }).join('');
}

function toggleShoppingCheck(id) {
  if (_shoppingChecked.has(id)) _shoppingChecked.delete(id);
  else _shoppingChecked.add(id);
  renderShopping();
}

function shareWhatsapp() {
  // FIX #6: se algum marcado ‚Üí envia s√≥ marcados; sen√£o envia todos
  const allItems = DB.products.filter(p => (DB.stock[p.id]||0) <= (p.alert||2));
  if (!allItems.length) { showToast('Nenhum item para comprar!'); return; }
  const toSend = _shoppingChecked.size > 0
    ? allItems.filter(p => _shoppingChecked.has(p.id))
    : allItems;
  if (!toSend.length) { showToast('Nenhum item selecionado!'); return; }
  const lines = toSend.map(p => {
    const q = DB.stock[p.id]||0;
    return `‚Ä¢ ${p.name}${q===0?' (ZERADO)':' ('+q+' restante)'}`;
  });
  const text = `üõí *Lista de Compras*\n\n${lines.join('\n')}\n\n_Gerado pelo app Despensa_`;
  window.open('https://wa.me/?text=' + encodeURIComponent(text));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id) {
  document.getElementById(id).classList.add('open');
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}
// close on overlay click (exceto product-modal que tem handler pr√≥prio)
document.querySelectorAll('.modal-overlay').forEach(ov => {
  if (ov.id === 'product-modal') return;
  ov.addEventListener('click', e => { if (e.target === ov) closeModal(ov.id); });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _authTab = 'login';

let _stockChoice = 'create'; // 'create' ou 'join'

function switchAuthTab(tab) {
  _authTab = tab;
  document.querySelectorAll('.auth-tab').forEach((b,i) => {
    b.classList.toggle('active', (i===0&&tab==='login')||(i===1&&tab==='register'));
  });
  const isReg = tab === 'register';
  document.getElementById('auth-username').style.display = isReg ? '' : 'none';
  document.getElementById('auth-password2').style.display = isReg ? '' : 'none';
  document.getElementById('auth-stock-choice').style.display = isReg ? '' : 'none';
  document.getElementById('auth-submit-btn').textContent = isReg ? 'Criar conta' : 'Entrar';
  document.getElementById('auth-error').textContent = '';
  if (isReg) selectStockChoice('create');
}

function selectStockChoice(choice) {
  _stockChoice = choice;
  document.getElementById('choice-create').classList.toggle('selected', choice === 'create');
  document.getElementById('choice-join').classList.toggle('selected', choice === 'join');
  document.getElementById('auth-stock-name').style.display = choice === 'create' ? '' : 'none';
  document.getElementById('auth-invite-code').style.display = choice === 'join' ? '' : 'none';
}

async function authSubmit() {
  const email    = document.getElementById('auth-email').value.trim();
  const password = document.getElementById('auth-password').value;
  const errEl    = document.getElementById('auth-error');
  const btn      = document.getElementById('auth-submit-btn');

  if (!email || !password) { errEl.textContent = 'Preencha email e senha.'; return; }

  if (_authTab === 'register') {
    const username  = document.getElementById('auth-username').value.trim();
    const password2 = document.getElementById('auth-password2').value;
    if (!username) { errEl.textContent = 'Digite um nome de usu√°rio.'; return; }
    if (password !== password2) { errEl.textContent = 'As senhas n√£o coincidem.'; return; }
    if (_stockChoice === 'create') {
      const stockName = document.getElementById('auth-stock-name').value.trim();
      if (!stockName) { errEl.textContent = 'Digite um nome para o estoque.'; return; }
    } else {
      const inviteCode = document.getElementById('auth-invite-code').value.trim();
      if (inviteCode.length !== 6) { errEl.textContent = 'O c√≥digo de convite tem 6 caracteres.'; return; }
    }
  }

  btn.disabled = true;
  errEl.textContent = '';

  try {
    const { auth, createUserWithEmailAndPassword, signInWithEmailAndPassword, db, doc, setDoc, getDoc, arrayUnion } = window._FB;

    if (_authTab === 'register') {
      const username   = document.getElementById('auth-username').value.trim();
      const cred       = await createUserWithEmailAndPassword(auth, email, password);
      const uid        = cred.user.uid;

      if (_stockChoice === 'join') {
        // Entrar em estoque existente via c√≥digo
        const inviteCode = document.getElementById('auth-invite-code').value.trim().toUpperCase();
        const codeSnap   = await getDoc(doc(db, 'invite_codes', inviteCode));
        if (!codeSnap.exists() || new Date(codeSnap.data().expiresAt) < new Date()) {
          errEl.textContent = 'C√≥digo inv√°lido ou expirado.';
          btn.disabled = false;
          return;
        }
        const despensaId = codeSnap.data().despensaId;
        await setDoc(doc(db, 'users', uid), { despensaId, email, username, joinedAt: new Date().toISOString() });
        await setDoc(doc(db, 'despensas', despensaId), { members: arrayUnion(uid) }, { merge: true });
      } else {
        // Criar novo estoque
        const stockName = document.getElementById('auth-stock-name').value.trim();
        await setDoc(doc(db, 'users', uid), { despensaId: uid, email, username, stockName, joinedAt: new Date().toISOString() });
        await setDoc(doc(db, 'despensas', uid), { members: [uid], stockName, createdAt: new Date().toISOString() });
      }
    } else {
      await signInWithEmailAndPassword(auth, email, password);
    }
  } catch(e) {
    const msgs = {
      'auth/email-already-in-use': 'Este email j√° est√° cadastrado.',
      'auth/invalid-email': 'Email inv√°lido.',
      'auth/weak-password': 'Senha fraca ‚Äî m√≠nimo 6 caracteres.',
      'auth/user-not-found': 'Email n√£o encontrado.',
      'auth/wrong-password': 'Senha incorreta.',
      'auth/invalid-credential': 'Email ou senha incorretos.',
    };
    errEl.textContent = msgs[e.code] || 'Erro: ' + e.message;
  }
  btn.disabled = false;
}

async function authGoogle() {
  try {
    const { auth, signInWithPopup, googleProvider } = window._FB;
    await signInWithPopup(auth, googleProvider);
  } catch(e) {
    if (e.code !== 'auth/popup-closed-by-user') {
      document.getElementById('auth-error').textContent = 'Erro ao entrar com Google.';
    }
  }
}

async function doSignOut() {
  if (!confirm('Sair da conta?')) return;
  DB.stopSync();
  const { auth, signOut } = window._FB;
  await signOut(auth);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SISTEMA DE CONVITES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _membersData = [];
let _currentUserIsOwner = false;

async function openMembersModal() {
  if (!window._FB || !DB._uid || !DB._despensaId) return;
  const { db, doc, getDoc, collection } = window._FB;

  // Carrega membros da despensa
  const despensaSnap = await getDoc(doc(db, 'despensas', DB._despensaId));
  const memberUids = despensaSnap.exists() ? (despensaSnap.data().members || [DB._despensaId]) : [DB._despensaId];

  // Carrega perfis dos membros
  _membersData = await Promise.all(memberUids.map(async uid => {
    const uSnap = await getDoc(doc(db, 'users', uid));
    return { uid, email: uSnap.exists() ? uSnap.data().email : uid, isOwner: uid === DB._despensaId };
  }));

  _currentUserIsOwner = DB._uid === DB._despensaId;

  // Mostra/esconde se√ß√µes conforme papel
  document.getElementById('invite-code-section').style.display = _currentUserIsOwner ? '' : 'none';
  document.getElementById('join-code-section').style.display = _currentUserIsOwner ? 'none' : '';
  document.getElementById('join-error').textContent = '';

  // Nome da despensa
  const ownerMember = _membersData.find(m => m.isOwner);
  document.getElementById('members-despensa-name').textContent =
    ownerMember ? `Despensa de ${ownerMember.email.split('@')[0]}` : 'Despensa compartilhada';

  // Renderiza lista de membros
  document.getElementById('members-list').innerHTML = _membersData.map(m => `
    <div class="member-item">
      <div class="member-avatar">${(m.email[0] || '?').toUpperCase()}</div>
      <div class="member-info">
        <div class="member-email">${m.email}</div>
        <div class="member-role">${m.isOwner ? 'üëë Dono' : 'üë§ Membro'}</div>
      </div>
    </div>
  `).join('');

  // Carrega c√≥digo de convite ativo se for dono
  if (_currentUserIsOwner) {
    await loadActiveInviteCode();
  }

  document.getElementById('members-modal').classList.add('open');
}

function closeMembersModal() {
  document.getElementById('members-modal').classList.remove('open');
}

async function loadActiveInviteCode() {
  if (!window._FB || !DB._despensaId) return;
  const { db, doc, getDoc } = window._FB;
  const inviteRef = doc(db, 'invites', DB._despensaId);
  const inviteSnap = await getDoc(inviteRef);

  if (inviteSnap.exists()) {
    const data = inviteSnap.data();
    const expiry = new Date(data.expiresAt);
    if (expiry > new Date()) {
      document.getElementById('invite-code-display').textContent = data.code;
      document.getElementById('invite-code-expiry').textContent =
        'Expira em ' + expiry.toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' });
      return;
    }
  }
  document.getElementById('invite-code-display').textContent = '‚Äî‚Äî';
  document.getElementById('invite-code-expiry').textContent = 'Nenhum c√≥digo ativo';
}

async function generateInviteCode() {
  if (!window._FB || !DB._despensaId) return;
  const { db, doc, setDoc } = window._FB;

  // Gera c√≥digo de 6 letras
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];

  const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(); // 24h

  await setDoc(doc(db, 'invites', DB._despensaId), {
    code,
    despensaId: DB._despensaId,
    ownerEmail: window._FB.auth.currentUser?.email || '',
    createdAt: new Date().toISOString(),
    expiresAt
  });

  // Cria √≠ndice reverso para lookup pelo c√≥digo
  await setDoc(doc(db, 'invite_codes', code), {
    despensaId: DB._despensaId,
    expiresAt
  });

  document.getElementById('invite-code-display').textContent = code;
  document.getElementById('invite-code-expiry').textContent =
    'Expira em 24 horas';
  showToast('C√≥digo gerado! Compartilhe com os membros.');
}

function copyInviteCode() {
  const code = document.getElementById('invite-code-display').textContent;
  if (code === '‚Äî‚Äî') { showToast('Gere um c√≥digo primeiro'); return; }
  navigator.clipboard.writeText(code).then(() => showToast('C√≥digo copiado!')).catch(() => {
    // fallback
    const el = document.createElement('input');
    el.value = code;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    showToast('C√≥digo copiado!');
  });
}

async function joinWithCode() {
  const code = document.getElementById('join-code-input').value.trim().toUpperCase();
  const errEl = document.getElementById('join-error');
  if (code.length !== 6) { errEl.textContent = 'O c√≥digo tem 6 caracteres.'; return; }
  if (!window._FB || !DB._uid) return;

  errEl.textContent = '';
  const { db, doc, getDoc, setDoc, arrayUnion } = window._FB;

  try {
    // Busca o convite pelo c√≥digo
    const codeSnap = await getDoc(doc(db, 'invite_codes', code));
    if (!codeSnap.exists()) { errEl.textContent = 'C√≥digo inv√°lido ou expirado.'; return; }

    const { despensaId, expiresAt } = codeSnap.data();
    if (new Date(expiresAt) < new Date()) { errEl.textContent = 'Este c√≥digo expirou.'; return; }
    if (despensaId === DB._despensaId) { errEl.textContent = 'Voc√™ j√° faz parte desta despensa.'; return; }

    // Atualiza perfil do usu√°rio com nova despensaId
    await setDoc(doc(db, 'users', DB._uid), {
      despensaId,
      email: window._FB.auth.currentUser?.email || '',
      joinedAt: new Date().toISOString()
    }, { merge: true });

    // Adiciona uid √† lista de membros da despensa
    await setDoc(doc(db, 'despensas', despensaId), {
      members: arrayUnion(DB._uid)
    }, { merge: true });

    closeMembersModal();
    showToast('Entrou na despensa com sucesso!');

    // Reinicia sync apontando para nova despensa
    DB.stopSync();
    await DB.startSync(DB._uid);
  } catch(e) {
    errEl.textContent = 'Erro ao entrar. Tente novamente.';
    console.error(e);
  }
}

// Fecha clicando fora
document.getElementById('members-modal').addEventListener('click', function(e) {
  if (e.target === this) closeMembersModal();
});

// Listener principal de autentica√ß√£o
function initAuth() {
  if (!window._FB) { setTimeout(initAuth, 100); return; }
  const { auth, onAuthStateChanged } = window._FB;
  onAuthStateChanged(auth, (user) => {
    if (user) {
      // Logado ‚Äî esconde auth screen, mostra app
      document.getElementById('auth-screen').classList.add('hidden');
      // username ser√° carregado ap√≥s startSync buscar o perfil
      // Garante que o email est√° salvo no perfil
      if (window._FB) {
        const { db, doc, setDoc } = window._FB;
        setDoc(doc(db, 'users', user.uid), { email: user.email || user.displayName || '' }, { merge: true });
      }
      DB.startSync(user.uid);
    } else {
      // Deslogado ‚Äî mostra auth screen
      document.getElementById('auth-screen').classList.remove('hidden');
      DB.stopSync();
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
renderHome();
renderCatTabs();
initAuth();

// Register service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/estoque-manager/sw.js', { scope: '/estoque-manager/' })
    .catch(e => console.warn('SW:', e));
}

// CSS spin animation para sync indicator
const _spinStyle = document.createElement('style');
_spinStyle.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
document.head.appendChild(_spinStyle);
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCANNER OVERLAY ‚Äî completamente isolado
     z-index 9999, fora do #app, invis√≠vel por padr√£o
     S√≥ existe quando aberto, some completamente ao fechar
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="scanner-overlay" style="
  display: none;
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: #000;
  touch-action: none;
">
  <video id="scanner-video" autoplay muted playsinline style="
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  "></video>

  <!-- Header -->
  <div style="
    position: absolute;
    top: 0; left: 0; right: 0;
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 52px 20px 16px;
  ">
    <button onclick="closeScanner()" style="
      width: 38px; height: 38px;
      border-radius: 50%;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      touch-action: manipulation;
    ">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
    </button>
    <h2 style="font-family:'Syne',sans-serif;font-size:18px;font-weight:700;color:white;">Escanear</h2>
  </div>

  <!-- Viewfinder -->
  <div style="
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  ">
    <div id="scan-frame" style="width:240px;height:240px;position:relative;">
      <!-- cantos do frame -->
      <div style="position:absolute;top:0;left:0;width:32px;height:32px;border-top:3px solid #a78bfa;border-left:3px solid #a78bfa;border-radius:4px 0 0 0;"></div>
      <div style="position:absolute;top:0;right:0;width:32px;height:32px;border-top:3px solid #a78bfa;border-right:3px solid #a78bfa;border-radius:0 4px 0 0;"></div>
      <div style="position:absolute;bottom:0;left:0;width:32px;height:32px;border-bottom:3px solid #a78bfa;border-left:3px solid #a78bfa;border-radius:0 0 0 4px;"></div>
      <div style="position:absolute;bottom:0;right:0;width:32px;height:32px;border-bottom:3px solid #a78bfa;border-right:3px solid #a78bfa;border-radius:0 0 4px 0;"></div>
      <!-- linha de scan -->
      <div style="
        position:absolute;left:4px;right:4px;height:2px;
        background:linear-gradient(90deg,transparent,#a78bfa,transparent);
        box-shadow:0 0 8px #7c6af7;
        animation:scanMove 2s ease-in-out infinite;
      "></div>
    </div>
    <p style="margin-top:28px;color:rgba(255,255,255,0.7);font-size:13px;text-align:center;padding:0 40px;">
      Aponte para um QR Code ou c√≥digo de barras
    </p>
  </div>

  <!-- Bot√£o manual ‚Äî na parte inferior, bem longe de qualquer outro elemento -->
  <div style="
    position: absolute;
    bottom: 48px;
    left: 20px; right: 20px;
  ">
    <button onclick="manualCode()" style="
      width: 100%;
      padding: 16px;
      border-radius: 14px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      cursor: pointer;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      touch-action: manipulation;
    ">‚úèÔ∏è Digitar c√≥digo manualmente</button>
  </div>
</div>


<script>
// Solicita persist√™ncia de dados ‚Äî evita que iOS limpe o localStorage
if (navigator.storage && navigator.storage.persist) {
  navigator.storage.persist().then(granted => {
    console.log('Persist√™ncia:', granted ? 'PERMITIDA' : 'NEGADA');
  });
}

// Impede que links internos abram o Safari no iOS
document.addEventListener('click', function(e) {
  const a = e.target.closest('a');
  if (!a) return;
  try {
    if (new URL(a.href).origin === location.origin) {
      e.preventDefault();
      window.location.href = a.href;
    }
  } catch(err) {}
});
</script>
</body>
</html>
